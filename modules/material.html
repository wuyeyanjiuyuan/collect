<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<style>
    /* === å®¹å™¨å¸ƒå±€ === */
    #material-app {
        font-family: 'Segoe UI', sans-serif;
        color: #333;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        min-height: 800px; /* ä¿è¯æœ‰è¶³å¤Ÿç©ºé—´ */
        position: relative;
        display: flex;
        flex-direction: column;
    }

    /* === 1. é¡¶éƒ¨ï¼šå‘¨æœŸè¡¨åŒºåŸŸ === */
    #periodic-table-container {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        transition: all 0.5s ease;
    }

    /* ç½‘æ ¼å¸ƒå±€ï¼š18åˆ— */
    .periodic-grid {
        display: grid;
        grid-template-columns: repeat(18, 1fr);
        gap: 4px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .element-cell {
        aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ */
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        position: relative;
        user-select: none;
    }

    .element-cell:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10;
        border-color: #3498db;
    }

    .element-cell.empty {
        background: transparent;
        border: none;
        pointer-events: none;
    }

    .atom-num { font-size: 10px; position: absolute; top: 2px; left: 4px; color: #999; }
    .atom-sym { font-size: 18px; font-weight: bold; color: #2c3e50; }
    .atom-name { font-size: 9px; color: #666; margin-top: 2px; display:none; } /* å°å±éšè—åå­— */

    /* é€‰ä¸­çŠ¶æ€ */
    .element-cell.active {
        background: #2c3e50;
        border-color: #2c3e50;
    }
    .element-cell.active .atom-sym { color: #fff; }
    .element-cell.active .atom-num { color: #aaa; }

    /* === 2. åº•éƒ¨ï¼šè¯¦ç»†ä¿¡æ¯é¢æ¿ (åˆå§‹éšè—) === */
    #detail-panel {
        flex: 1;
        display: flex;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
        visibility: hidden; /* é¿å…ç‚¹ä¸åˆ° */
        border-top: 1px solid #eee;
    }
    
    #detail-panel.show {
        opacity: 1;
        transform: translateY(0);
        visibility: visible;
    }

    /* å·¦ä¾§ï¼šæ–‡å­—ä¿¡æ¯ */
    .info-column {
        flex: 4;
        padding: 30px;
        overflow-y: auto;
        background: #fff;
        border-right: 1px solid #eee;
        max-height: 600px;
    }

    .info-header { border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; }
    .info-header h1 { margin: 0; font-size: 3rem; color: #2c3e50; display: inline-block; }
    .info-header span { font-size: 1.5rem; color: #7f8c8d; margin-left: 10px; }
    
    .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .data-item { background: #f0f7ff; padding: 10px; border-radius: 6px; }
    .data-label { font-size: 12px; color: #7f8c8d; display: block; }
    .data-value { font-size: 16px; font-weight: 500; color: #333; }

    .compound-section { margin-top: 30px; }
    .compound-btn {
        padding: 8px 16px;
        margin-right: 10px;
        margin-bottom: 10px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 20px;
        cursor: pointer;
        transition: 0.3s;
    }
    .compound-btn:hover, .compound-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }

    /* å³ä¾§ï¼š3D ç”»å¸ƒ */
    .canvas-column {
        flex: 6;
        position: relative;
        background: #1a1a1a; /* 3DèƒŒæ™¯æ·±è‰² */
        min-height: 400px;
    }
    #three-canvas { width: 100%; height: 100%; display: block; }
    
    .view-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: rgba(255,255,255,0.1);
        padding: 10px;
        border-radius: 8px;
        backdrop-filter: blur(5px);
    }
    .view-hint { color: #aaa; font-size: 12px; }

    @media(max-width: 900px) {
        #detail-panel { flex-direction: column; }
        .periodic-grid { grid-template-columns: repeat(9, 1fr); } /* æ‰‹æœºç«¯é€‚é… */
    }
</style>

<div id="material-app">
    <div id="periodic-table-container">
        <h2 style="margin: 0 0 15px 10px; color: #2c3e50;">å…ƒç´ å‘¨æœŸè¡¨ <small style="font-size:14px; color:#999; font-weight:normal">ç‚¹å‡»å…ƒç´ æŸ¥çœ‹å¾®è§‚ç»“æ„</small></h2>
        <div class="periodic-grid" id="grid-root">
            </div>
    </div>

    <div id="detail-panel">
        <div class="info-column">
            <div class="info-header">
                <h1 id="el-symbol">H</h1>
                <span id="el-name">Hydrogen</span>
            </div>

            <div class="data-grid">
                <div class="data-item"><span class="data-label">åŸå­åºæ•°</span><span class="data-value" id="el-num">1</span></div>
                <div class="data-item"><span class="data-label">åŸå­é‡</span><span class="data-value" id="el-mass">1.008</span></div>
                <div class="data-item"><span class="data-label">ç”µå­æ’å¸ƒ</span><span class="data-value" id="el-config">1sÂ¹</span></div>
                <div class="data-item"><span class="data-label">ç±»åˆ«</span><span class="data-value" id="el-category">éé‡‘å±</span></div>
            </div>

            <div class="desc-box">
                <h3>ğŸ“– æ€§è´¨ä»‹ç»</h3>
                <p id="el-desc" style="line-height: 1.6; color: #555;">
                    è¿™é‡Œæ˜¯é»˜è®¤æè¿°...
                </p>
            </div>

            <div class="compound-section">
                <h3>ğŸ§¬ ç»“æ„ä¸åŒ–åˆç‰©å±•ç¤º</h3>
                <p style="font-size:12px; color:#999;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ‡æ¢ 3D æ¨¡å‹ï¼š</p>
                <div id="compound-list">
                    </div>
            </div>
        </div>

        <div class="canvas-column">
            <div id="three-canvas"></div>
            <div class="view-controls">
                <div class="view-hint">ğŸ–±ï¸ å·¦é”®æ—‹è½¬ | å³é”®å¹³ç§» | æ»šè½®ç¼©æ”¾</div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // ==========================================
    // 1. æ•°æ®ä¸­å¿ƒ (DATA CENTER)
    // ==========================================
    
    // ç®€åŒ–ç‰ˆçš„å‘¨æœŸè¡¨å¸ƒå±€æ•°æ® (Index å¯¹åº” 1-18 åˆ—)
    // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘åªè¯¦ç»†å†™äº†å‰å‡ ä¸ªå’Œéƒ¨åˆ†é‡è¦å…ƒç´ ã€‚å®é™…å¼€å‘ä½ å¯ä»¥æ‰¾ä¸ª JSON åº“å¯¼å…¥ã€‚
    const ELEMENTS_DB = {
        1: { sym: "H", name: "æ°¢ (Hydrogen)", mass: "1.008", config: "1sÂ¹", cat: "éé‡‘å±", 
             desc: "æ°¢æ˜¯å®‡å®™ä¸­æœ€ä¸°å¯Œçš„å…ƒç´ ã€‚åœ¨æ ‡å‡†æ¡ä»¶ä¸‹ï¼Œå®ƒæ˜¯æ— è‰²ã€æ— è‡­ã€éé‡‘å±ã€æ— å‘³ã€é«˜åº¦æ˜“ç‡ƒçš„åŒåŸå­æ°”ä½“ã€‚",
             // 3D æ¨¡å‹æ•°æ®ï¼šåŒ…å«å•è´¨å’ŒåŒ–åˆç‰©
             models: [
                 { name: "æ°¢åŸå­ (H)", type: "atom", color: "#ffffff", radius: 5, electrons: 1 },
                 { name: "æ°¢æ°” (Hâ‚‚)", type: "molecule", atoms: [
                     {x: -3, y:0, z:0, r: 5, c: "#ffffff"}, {x: 3, y:0, z:0, r: 5, c: "#ffffff"}
                 ], bonds: [[0,1]] },
                 { name: "æ°´ (Hâ‚‚O)", type: "molecule", atoms: [
                     {x: 0, y:0, z:0, r: 8, c: "#e74c3c"}, // O
                     {x: 8, y:-5, z:0, r: 5, c: "#ffffff"}, // H
                     {x: -8, y:-5, z:0, r: 5, c: "#ffffff"} // H
                 ], bonds: [[0,1], [0,2]] }
             ]
        },
        2: { sym: "He", name: "æ°¦ (Helium)", mass: "4.002", config: "1sÂ²", cat: "ç¨€æœ‰æ°”ä½“",
             desc: "æ°¦æ˜¯æ‰€æœ‰å…ƒç´ ä¸­æ²¸ç‚¹æœ€ä½çš„ã€‚å®ƒç”¨äºä½æ¸©ç ”ç©¶ã€æ°”çƒå……æ°”ä»¥åŠæ·±æµ·æ½œæ°´ã€‚",
             models: [
                 { name: "æ°¦åŸå­", type: "atom", color: "#ffcccc", radius: 6, electrons: 2 }
             ]
        },
        6: { sym: "C", name: "ç¢³ (Carbon)", mass: "12.011", config: "[He] 2sÂ² 2pÂ²", cat: "éé‡‘å±",
             desc: "ç¢³æ˜¯ç”Ÿå‘½çš„åŸºç¡€ã€‚å®ƒå¯ä»¥å½¢æˆçŸ³å¢¨ã€é‡‘åˆšçŸ³ç­‰å¤šç§åŒç´ å¼‚å½¢ä½“ã€‚",
             models: [
                { name: "ç”²çƒ· (CHâ‚„)", type: "molecule", atoms: [
                     {x: 0, y:0, z:0, r: 7, c: "#333333"}, // C
                     {x: 6, y:6, z:6, r: 4, c: "#ffffff"}, 
                     {x: -6, y:-6, z:6, r: 4, c: "#ffffff"},
                     {x: -6, y:6, z:-6, r: 4, c: "#ffffff"},
                     {x: 6, y:-6, z:-6, r: 4, c: "#ffffff"}
                 ], bonds: [[0,1], [0,2], [0,3], [0,4]] },
                 { name: "ç¢³åŸå­", type: "atom", color: "#333333", radius: 7, electrons: 6 }
             ]
        },
        // ... ä½ å¯ä»¥ç»§ç»­æ·»åŠ  Fe, Au ç­‰
    };

    // å¸ƒå±€è¾…åŠ©æ•°ç»„ (è¡Œ, åˆ—) -> åŸå­åºæ•°
    // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æ˜ å°„ï¼Œç”¨äºç”Ÿæˆç½‘æ ¼ã€‚
    const LAYOUT_MAP = [
        [1,1],[1,18], // ç¬¬1è¡Œ H, He
        [2,1],[2,2],[2,13],[2,14],[2,15],[2,16],[2,17],[2,18], // ç¬¬2è¡Œ Li...Ne
        // ç®€å•èµ·è§ï¼Œè¿™é‡Œæˆ‘å†™ä¸ªå‡½æ•°æ¥åˆ¤æ–­ç©ºä½
    ];

    // ==========================================
    // 2. é¡µé¢é€»è¾‘ (UI Logic)
    // ==========================================
    
    const gridRoot = document.getElementById('grid-root');
    const appData = {
        scene: null, camera: null, renderer: null, controls: null,
        currentGroup: null, // å­˜å‚¨å½“å‰çš„ 3D å¯¹è±¡ç»„ï¼Œæ–¹ä¾¿åˆ é™¤
        animationId: null
    };

    // åˆå§‹åŒ–å‘¨æœŸè¡¨ç½‘æ ¼
    function initGrid() {
        // åˆ›å»º 7è¡Œ x 18åˆ— çš„ç½‘æ ¼
        // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç®€åŒ–çš„å¾ªç¯é€»è¾‘ï¼š
        // çœŸå®å‘¨æœŸè¡¨é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç”¨ç®€åŒ–çš„å ä½ç¬¦é€»è¾‘
        // 1-18 åˆ—
        const tableStructure = [
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2], // Row 1
            [3,4,0,0,0,0,0,0,0,0,0,0,5,6,7,8,9,10], // Row 2
            [11,12,0,0,0,0,0,0,0,0,0,0,13,14,15,16,17,18], // Row 3
            // ... æ›´å¤šè¡Œå®é™…å¼€å‘æ—¶è¡¥å…¨
        ];

        // å¡«å…… DOM
        tableStructure.forEach(row => {
            row.forEach(atomicNum => {
                const cell = document.createElement('div');
                cell.className = 'element-cell';
                
                if (atomicNum === 0) {
                    cell.classList.add('empty');
                } else {
                    const data = ELEMENTS_DB[atomicNum];
                    // å¦‚æœæ•°æ®åº“é‡Œæ²¡è¿™ä¸ªå…ƒç´ ï¼Œå°±åªæ˜¾ç¤ºæ•°å­—åšä¸ªå ä½
                    const sym = data ? data.sym : "?";
                    
                    cell.innerHTML = `
                        <span class="atom-num">${atomicNum}</span>
                        <span class="atom-sym">${sym}</span>
                    `;
                    cell.onclick = () => loadElementDetail(atomicNum, cell);
                }
                gridRoot.appendChild(cell);
            });
        });
        
        // åˆå§‹åŒ– 3D ç¯å¢ƒ (åªåšä¸€æ¬¡)
        initThreeJS();
    }

    function loadElementDetail(id, cellDom) {
        // é«˜äº®é€‰ä¸­
        document.querySelectorAll('.element-cell').forEach(c => c.classList.remove('active'));
        cellDom.classList.add('active');

        const data = ELEMENTS_DB[id];
        if (!data) {
            alert("å¼€å‘ä¸­... è¯¥å…ƒç´ æ•°æ®å°šæœªå½•å…¥");
            return;
        }

        // å¡«å……æ–‡å­—ä¿¡æ¯
        document.getElementById('el-symbol').innerText = data.sym;
        document.getElementById('el-name').innerText = data.name;
        document.getElementById('el-num').innerText = id;
        document.getElementById('el-mass').innerText = data.mass;
        document.getElementById('el-config').innerText = data.config;
        document.getElementById('el-category').innerText = data.cat;
        document.getElementById('el-desc').innerText = data.desc;

        // ç”Ÿæˆ 3D åˆ‡æ¢æŒ‰é’®
        const btnContainer = document.getElementById('compound-list');
        btnContainer.innerHTML = '';
        
        if (data.models && data.models.length > 0) {
            data.models.forEach((model, index) => {
                const btn = document.createElement('button');
                btn.className = 'compound-btn';
                btn.innerText = model.name;
                btn.onclick = () => {
                    document.querySelectorAll('.compound-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderModel(model);
                };
                btnContainer.appendChild(btn);
            });
            // é»˜è®¤ç‚¹ç¬¬ä¸€ä¸ª
            btnContainer.children[0].click();
        } else {
            clearScene();
            btnContainer.innerHTML = '<p>æš‚æ— ç»“æ„æ•°æ®</p>';
        }

        // æ˜¾ç¤ºé¢æ¿
        document.getElementById('detail-panel').classList.add('show');
    }

    // ==========================================
    // 3. Three.js æ ¸å¿ƒ (3D Engine)
    // ==========================================

    function initThreeJS() {
        const container = document.getElementById('three-canvas');
        const w = container.clientWidth;
        const h = container.clientHeight;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);

        // ç¯å…‰
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);

        const camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
        camera.position.set(0, 0, 40);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(w, h);
        container.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        appData.scene = scene;
        appData.camera = camera;
        appData.renderer = renderer;
        appData.controls = controls;

        animate();
    }

    function animate() {
        appData.animationId = requestAnimationFrame(animate);
        if(appData.controls) appData.controls.update();
        if(appData.renderer && appData.scene && appData.camera) {
            appData.renderer.render(appData.scene, appData.camera);
        }
        
        // å¦‚æœæ˜¯åŸå­æ¨¡å‹ï¼Œå¯ä»¥è®©ç”µå­æ—‹è½¬
        if (appData.currentGroup && appData.currentGroup.userData.type === 'atom') {
            appData.currentGroup.children.forEach(child => {
                if (child.userData.isElectron) {
                    // ç®€å•çš„è½¨é“æ—‹è½¬é€»è¾‘
                    const time = Date.now() * 0.001 * child.userData.speed;
                    child.position.x = Math.cos(time + child.userData.offset) * child.userData.radius;
                    child.position.z = Math.sin(time + child.userData.offset) * child.userData.radius;
                }
            });
        }
    }

    // â˜…â˜…â˜… æ ¸å¿ƒï¼šæ¸²æŸ“ä¸åŒç±»å‹çš„æ¨¡å‹ â˜…â˜…â˜…
    function renderModel(modelData) {
        clearScene();
        const group = new THREE.Group();
        group.userData.type = modelData.type; // æ ‡è®°ç±»å‹ä»¥ä¾¿åŠ¨ç”»ä½¿ç”¨

        if (modelData.type === 'molecule') {
            // === æ¨¡å¼ A: åˆ†å­ (çƒæ£æ¨¡å‹) ===
            const materialCache = {}; // ç¼“å­˜æè´¨ä¼˜åŒ–æ€§èƒ½

            // 1. ç”»åŸå­
            modelData.atoms.forEach((atom, idx) => {
                const geo = new THREE.SphereGeometry(atom.r * 0.4, 32, 32);
                const mat = new THREE.MeshPhongMaterial({ color: atom.c, shininess: 100 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(atom.x, atom.y, atom.z);
                group.add(mesh);
            });

            // 2. ç”»é”® (Bonds)
            if (modelData.bonds) {
                modelData.bonds.forEach(pair => {
                    const idx1 = pair[0];
                    const idx2 = pair[1];
                    const p1 = modelData.atoms[idx1];
                    const p2 = modelData.atoms[idx2];
                    
                    const v1 = new THREE.Vector3(p1.x, p1.y, p1.z);
                    const v2 = new THREE.Vector3(p2.x, p2.y, p2.z);
                    const distance = v1.distanceTo(v2);
                    
                    // æ£å­ä½ç½®åœ¨ä¸¤ç‚¹ä¸­å¿ƒ
                    const mid = v1.clone().add(v2).multiplyScalar(0.5);
                    
                    const cylinderGeo = new THREE.CylinderGeometry(0.8, 0.8, distance, 12);
                    const cylinderMat = new THREE.MeshPhongMaterial({ color: 0xcccccc });
                    const cylinder = new THREE.Mesh(cylinderGeo, cylinderMat);
                    
                    cylinder.position.copy(mid);
                    cylinder.lookAt(v1); // æœå‘å…¶ä¸­ä¸€ä¸ªåŸå­
                    cylinder.rotateX(Math.PI / 2); // è°ƒæ•´åœ†æŸ±ä½“é»˜è®¤è½´å‘
                    
                    group.add(cylinder);
                });
            }

        } else if (modelData.type === 'atom') {
            // === æ¨¡å¼ B: åŸå­ç»“æ„ (æ³¢å°”æ¨¡å‹) ===
            
            // 1. åŸå­æ ¸
            const nucleusGeo = new THREE.SphereGeometry(2, 32, 32);
            const nucleusMat = new THREE.MeshPhongMaterial({ color: modelData.color, emissive: 0x222222 });
            const nucleus = new THREE.Mesh(nucleusGeo, nucleusMat);
            group.add(nucleus);

            // 2. ç”µå­è½¨é“å’Œç”µå­
            // ç®€å•æ¨¡æ‹Ÿï¼šæ ¹æ®ç”µå­æ•°ç”»å‡ ä¸ªè½¨é“
            const electronCount = modelData.electrons;
            const shells = Math.ceil(Math.sqrt(electronCount)); // ç²—ç•¥ä¼°ç®—å±‚æ•°
            
            for(let i=0; i<electronCount; i++) {
                const orbitRadius = 6 + (i%shells) * 3;
                
                // ç”»è½¨é“çº¿ (è§†è§‰è¾…åŠ©)
                // è¿™é‡Œå·æ‡’çœç•¥è½¨é“çº¿åœˆï¼Œç›´æ¥ç”»ç”µå­
                
                const electronGeo = new THREE.SphereGeometry(0.5, 16, 16);
                const electronMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                const electron = new THREE.Mesh(electronGeo, electronMat);
                
                // å­˜å…¥è‡ªå®šä¹‰æ•°æ®ä¾› animate() ä½¿ç”¨
                electron.userData = {
                    isElectron: true,
                    radius: orbitRadius,
                    speed: 1 + Math.random(),
                    offset: Math.random() * Math.PI * 2
                };
                
                group.add(electron);
            }
        }

        appData.currentGroup = group;
        appData.scene.add(group);
    }

    function clearScene() {
        if (appData.currentGroup) {
            appData.scene.remove(appData.currentGroup);
            // é‡Šæ”¾å†…å­˜ (Three.js é‡è¦æ­¥éª¤)
            appData.currentGroup.traverse((obj) => {
                if (obj.geometry) obj.geometry.dispose();
                if (obj.material) {
                    if (Array.isArray(obj.material)) {
                        obj.material.forEach(m => m.dispose());
                    } else {
                        obj.material.dispose();
                    }
                }
            });
            appData.currentGroup = null;
        }
    }

    // å¯åŠ¨
    initGrid();

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
        const container = document.getElementById('three-canvas');
        if(container && appData.camera && appData.renderer) {
             const w = container.clientWidth;
             const h = container.clientHeight;
             appData.camera.aspect = w / h;
             appData.camera.updateProjectionMatrix();
             appData.renderer.setSize(w, h);
        }
    });

})();
</script>