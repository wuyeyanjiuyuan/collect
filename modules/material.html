<!DOCTYPE html>
<style>
    :root {
        --mat-bg: #ffffff;
        --mat-text: #2c3e50;
        --mat-accent: #2980b9;
        --cell-border: #dfe6e9;
    }

    #material-app {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; /* 学术常用字体 */
        background: var(--mat-bg);
        color: var(--mat-text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding-bottom: 50px;
    }

    /* === 顶部：周期表区域 === */
    .pt-container {
        padding: 20px;
        overflow-x: auto; /* 小屏可横向滚动 */
        border-bottom: 2px solid var(--mat-accent);
    }

    .pt-grid {
        display: grid;
        grid-template-columns: repeat(18, 1fr);
        gap: 2px;
        min-width: 900px; /* 保证周期表不走样 */
        max-width: 1400px;
        margin: 0 auto;
    }

    .pt-cell {
        aspect-ratio: 1;
        border: 1px solid var(--cell-border);
        padding: 2px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
        background: #fdfdfd;
    }
    
    .pt-cell:hover {
        transform: scale(1.2);
        z-index: 10;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        background: #fff;
        border-color: var(--mat-accent);
    }

    .pt-cell.active {
        background: var(--mat-accent);
        color: white;
        border-color: var(--mat-accent);
    }
    .pt-cell.active .num, .pt-cell.active .mass { color: rgba(255,255,255,0.8); }

    .pt-cell.empty { border: none; background: transparent; pointer-events: none; }

    .pt-cell .num { font-size: 10px; color: #7f8c8d; }
    .pt-cell .sym { font-size: 1.2rem; font-weight: bold; text-align: center; }
    .pt-cell .mass { font-size: 9px; color: #95a5a6; text-align: right; overflow: hidden; white-space: nowrap;}

    /* 镧系锕系标记 */
    .lanthanoid { background: #e8f6f3; }
    .actinoid { background: #fbeee6; }

    /* === 底部：扩展详情区 (科研核心) === */
    #detail-section {
        display: none; /* 默认隐藏 */
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
        padding: 30px 20px;
        background: #fafafa;
        border-bottom: 1px solid #ddd;
    }

    #detail-section.active {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* 左侧：数据面板 */
    .info-panel {
        flex: 1 1 400px; /* 最小400px，自动伸缩 */
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.05);
    }

    .element-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; display: flex; align-items: baseline; gap: 15px; }
    .element-header h1 { margin: 0; font-size: 3rem; color: var(--mat-accent); }
    .element-header h2 { margin: 0; font-size: 1.5rem; color: #7f8c8d; font-weight: 300; }
    
    .prop-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    .prop-table td { padding: 8px 0; border-bottom: 1px solid #f1f1f1; }
    .prop-table .label { color: #7f8c8d; width: 40%; }
    .prop-table .value { font-weight: 500; color: #2c3e50; }

    /* 右侧：3D 视窗 (固定高度，宽度自适应) */
    .viewer-panel {
        flex: 1 1 500px;
        display: flex;
        flex-direction: column;
    }

    .viewer-container {
        width: 100%;
        height: 500px; /* 3D 画布高度 */
        background: #000; /* 黑色背景更有科研感 */
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        border: 1px solid #ccc;
    }

    #mol-canvas {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .viewer-controls {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .btn-sci {
        padding: 5px 15px; font-size: 12px; background: #fff; border: 1px solid #ccc; cursor: pointer;
        border-radius: 4px; transition: 0.2s;
    }
    .btn-sci:hover { background: var(--mat-accent); color: white; border-color: var(--mat-accent); }
    
    .loading-hint { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; pointer-events:none; }

</style>

<script src="js/3Dmol-min.js"></script>
<div id="material-app">
    <div class="pt-container">
        <h3 style="margin: 0 0 10px 20px; color:#555;">Periodic Table of Elements <span style="font-size:12px; font-weight:normal; color:#999;">Select an element to load CIF structure</span></h3>
        <div class="pt-grid" id="pt-grid">
            <div style="grid-column: 1/19; text-align:center; padding: 20px;">正在加载数据库...</div>
        </div>
    </div>

    <div id="detail-section">
        <div class="info-panel">
            <div class="element-header">
                <h1 id="disp-sym">Fe</h1>
                <h2 id="disp-name">Iron</h2>
            </div>
            <p id="disp-summary" style="line-height:1.6; color:#555; margin-bottom:20px;">
                Description loading...
            </p>

            <table class="prop-table">
                <tr><td class="label">Atomic Number</td><td class="value" id="disp-num">26</td></tr>
                <tr><td class="label">Atomic Mass</td><td class="value" id="disp-mass">55.845 u</td></tr>
                <tr><td class="label">Density</td><td class="value" id="disp-density">7.874 g/cm³</td></tr>
                <tr><td class="label">Melting Point</td><td class="value" id="disp-melt">1811 K</td></tr>
                <tr><td class="label">Electron Config</td><td class="value" id="disp-config">[Ar] 3d6 4s2</td></tr>
                <tr><td class="label">Discovery</td><td class="value" id="disp-discovery">Unknown</td></tr>
            </table>
        </div>

        <div class="viewer-panel">
            <div class="viewer-container">
                <div id="mol-canvas"></div>
                <div id="viewer-msg" class="loading-hint">等待选择元素...</div>
            </div>
            <div class="viewer-controls">
                <span style="margin-right:auto; font-size:12px; color:#666; align-self:center;">* 结构数据来源: COD / Materials Project</span>
                <button class="btn-sci" onclick="app.viewerStyle('sphere')">CPK Sphere</button>
                <button class="btn-sci" onclick="app.viewerStyle('stick')">Stick</button>
                <button class="btn-sci" onclick="app.viewerStyle('polyhedra')">Polyhedra</button>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
    // 科研应用命名空间
    const ResearchApp = {
        data: [], // 存储 fetch 下来的完整数据
        viewer: null, // 3Dmol 对象
        currentElement: null,

        init: async function() {
            try {
                // 1. 读取本地数据文件
                // 注意：请确保你上传了 elements.json 到 ../data/ 目录
                // 如果本地调试跨域报错，请使用 live-server 或 python -m http.server
                const response = await fetch('data/elements.json'); 
                // 为了演示，如果fetch失败(比如你还没传文件)，我先做一个假数据 fallback
                if(!response.ok) throw new Error("Data file not found");
                this.data = await response.json();
                
                this.renderTable();
            } catch (e) {
                console.error("加载数据失败，请检查路径 ../data/elements.json", e);
                document.getElementById('pt-grid').innerHTML = `<p style="color:red; grid-column:1/-1">错误: 无法加载数据文件 (${e.message})。<br>请确保 'elements.json' 已上传至 'data' 文件夹。</p>`;
            }
        },

        renderTable: function() {
            const grid = document.getElementById('pt-grid');
            grid.innerHTML = '';

            // 周期表 18列 x 7行 (加 镧系锕系)
            // 这里我们需要把 data 里的元素映射到 (xpos, ypos)
            // Bowserinator 的 JSON 数据通常包含 xpos, ypos 字段
            
            // 为了防止 JSON 格式差异，我们用标准的 grid 坐标映射
            // 这是一个简化的映射逻辑，保证位置正确
            this.data.elements.forEach(el => {
                const cell = document.createElement('div');
                cell.className = 'pt-cell';
                cell.style.gridColumn = el.xpos; // JSON 里的列
                cell.style.gridRow = el.ypos;    // JSON 里的行

                // 区分镧系/锕系
                if(el.category.includes('lanthan')) cell.classList.add('lanthanoid');
                if(el.category.includes('actin')) cell.classList.add('actinoid');

                cell.innerHTML = `
                    <span class="num">${el.number}</span>
                    <span class="sym">${el.symbol}</span>
                    <span class="mass">${el.atomic_mass.toFixed(2)}</span>
                `;

                cell.onclick = () => {
                    // 移除其他选中
                    document.querySelectorAll('.pt-cell').forEach(c => c.classList.remove('active'));
                    cell.classList.add('active');
                    this.loadDetail(el);
                };

                grid.appendChild(cell);
            });
        },

        loadDetail: function(el) {
            this.currentElement = el;
            const section = document.getElementById('detail-section');
            section.classList.add('active');

            // 1. 填充文本数据
            document.getElementById('disp-sym').innerText = el.symbol;
            document.getElementById('disp-name').innerText = el.name;
            document.getElementById('disp-summary').innerText = el.summary || "No description available.";
            document.getElementById('disp-num').innerText = el.number;
            document.getElementById('disp-mass').innerText = el.atomic_mass;
            document.getElementById('disp-density').innerText = el.density + " g/cm³";
            document.getElementById('disp-melt').innerText = el.melt ? el.melt + " K" : "N/A";
            document.getElementById('disp-config').innerText = el.electron_configuration;
            document.getElementById('disp-discovery').innerText = el.discovered_by || "Unknown";

            // 滚动到详情区 (为了体验更好)
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // 2. 加载 3D 结构 (科研级 CIF 加载)
            this.loadStructure(el.number);
        },

        loadStructure: function(atomicNumber) {
            const msg = document.getElementById('viewer-msg');
            msg.innerText = `正在请求晶体数据: ${atomicNumber}.cif ...`;
            msg.style.display = 'block';

            // 初始化 Viewer (单例)
            if(!this.viewer) {
                const element = $('#mol-canvas'); // 3Dmol 依赖 jQuery 选择器或原生
                // 3Dmol.createViewer(element, config)
                this.viewer = $3Dmol.createViewer("mol-canvas", {
                    backgroundColor: "black" // 科研常用黑色背景
                });
            }

            this.viewer.clear();

            // 构建文件路径: ../data/structures/26.cif
            const cifUrl = `data/structures/${atomicNumber}.cif`;

            // fetch CIF 文件
            fetch(cifUrl)
                .then(res => {
                    if(!res.ok) throw new Error("No structure file");
                    return res.text();
                })
                .then(cifData => {
                    msg.style.display = 'none';
                    
                    // 解析 CIF
                    const m = this.viewer.addModel(cifData, "cif");
                    
                    // 设置样式: 
                    // 1. 显示晶胞框 (Unit Cell Box)
                    this.viewer.addUnitCell(m);
                    
                    // 2. 显示原子 (Sphere)
                    this.viewer.setStyle({}, {sphere: {scale: 0.3}, stick: {radius: 0.1}});
                    
                    // 3. 复制超晶胞 (Supercell) - 看起来更像一块材料
                    // 3Dmol 支持 replicateUnitCell
                    this.viewer.replicateUnitCell(2, 2, 2, m); 

                    this.viewer.zoomTo();
                    this.viewer.render();
                })
                .catch(err => {
                    console.warn(err);
                    msg.innerText = `暂无该元素的晶体文件 (${atomicNumber}.cif)`;
                    // Fallback: 如果没有 CIF 文件，我们生成一个简单的占位球
                    this.viewer.clear();
                    this.viewer.addModel(); // empty model
                    this.viewer.addSphere({center:{x:0,y:0,z:0}, radius: 3, color: 'skyblue'});
                    this.viewer.zoomTo();
                    this.viewer.render();
                });
        },

        // 切换显示模式
        viewerStyle: function(type) {
            if(!this.viewer) return;
            this.viewer.removeAllLabels();
            
            if(type === 'sphere') {
                this.viewer.setStyle({}, {sphere: {scale: 0.8}});
            } else if (type === 'stick') {
                this.viewer.setStyle({}, {stick: {radius: 0.2}, sphere: {scale: 0.3}});
            } else if (type === 'polyhedra') {
                // 多面体模式 (适合观察配位)
                this.viewer.setStyle({}, {polyhedra: {outline: true}, stick: {radius:0.1}});
            }
            this.viewer.render();
        }
    };

    // 暴露给全局以便 HTML onclick 调用
    window.app = ResearchApp;

    // 启动
    ResearchApp.init();

})();
</script>