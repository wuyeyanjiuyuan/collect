<div id="music-app">
    <div class="m-header">
        <div class="m-title-group">
            <div class="m-icon">ğŸ¹</div>
            <div class="m-info">
                <h2 class="m-h2">é’¢ç´æ•™å­¦åŠ©æ‰‹ Ultimate</h2>
                <span id="status-display" class="m-status">åˆå§‹åŒ–ä¸­...</span>
            </div>
        </div>

        <div class="m-controls">
            <select id="song-select" class="m-select" onchange="MusicApp.loadSong(this.value)">
                <option value="" disabled selected>è¯»å–ä¹è°±...</option>
            </select>

            <div class="m-btn-group">
                <button class="m-btn m-btn-primary" onclick="MusicApp.togglePlay()" id="btn-play">â–¶ æ’­æ”¾</button>
                <button class="m-btn m-btn-danger" onclick="MusicApp.stop()">â¹ åœæ­¢</button>
            </div>
            
            <div class="m-speed-group">
                <span class="m-label">å€é€Ÿ:</span>
                <button class="m-btn-pill" onclick="MusicApp.setSpeed(0.5, this)">0.5</button>
                <button class="m-btn-pill active" onclick="MusicApp.setSpeed(1.0, this)">1.0</button>
                <button class="m-btn-pill" onclick="MusicApp.setSpeed(1.5, this)">1.5</button>
            </div>
        </div>
    </div>

    <div class="m-sheet-wrapper" id="sheet-wrapper">
        <div class="m-notation-scroll" id="scroll-container">
            <div id="notation-paper"></div>
            
            <div id="cursor" class="m-cursor">
                <div class="m-cursor-head"></div> </div>
            
            <div id="click-layer" class="m-click-layer"></div>
        </div>

        <div id="empty-state" class="m-empty-state">
            ğŸµ è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ä¹è°±å¼€å§‹ç»ƒä¹ 
        </div>
    </div>

    <div class="m-piano-container">
        <div class="m-piano-bar">
            <span class="m-hint">ğŸ’¡ æ“ä½œï¼šæ‹–åŠ¨çº¢çº¿æˆ–ç‚¹å‡»ä¹è°±å¯è·³è½¬ | Shift+æ»šè½®æ¨ªå‘çœ‹ç´</span>
            <button class="m-btn-small" onclick="MusicApp.scrollToCenter()">ğŸ¯ å›åˆ°ä¸­å¤® C</button>
        </div>
        
        <div class="m-piano-scroll-view" id="piano-scroll">
            <div id="piano-keyboard" class="m-piano-body"></div>
        </div>
    </div>
</div>

<style>
    /* === å¸ƒå±€ä¸åŸºç¡€ === */
    #music-app { width: 100%; font-family: 'Segoe UI', sans-serif; color: #333; display: flex; flex-direction: column; gap: 15px; }
    #music-app * { box-sizing: border-box; user-select: none; }

    /* é¡¶éƒ¨æ  */
    .m-header { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; }
    .m-title-group { display: flex; align-items: center; gap: 10px; }
    .m-icon { font-size: 24px; background: #e3f2fd; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    .m-h2 { margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50; }
    .m-status { font-size: 11px; color: #7f8c8d; }
    
    .m-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .m-select { padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; height: 32px; }
    
    .m-btn { border: none; padding: 0 15px; height: 32px; border-radius: 4px; color: white; cursor: pointer; font-weight: 600; font-size: 13px; }
    .m-btn-primary { background-color: #3498db; } .m-btn-primary:hover { background-color: #2980b9; }
    .m-btn-danger { background-color: #e74c3c; }
    
    .m-speed-group { display: flex; align-items: center; gap: 2px; background: #f5f6fa; padding: 3px; border-radius: 20px; }
    .m-label { font-size: 11px; color: #999; margin: 0 5px; }
    .m-btn-pill { border: none; background: none; color: #666; font-size: 11px; padding: 4px 8px; border-radius: 12px; cursor: pointer; }
    .m-btn-pill.active { background: #3498db; color: white; }

    /* === ä¹è°±åŒºåŸŸ (æ ¸å¿ƒ) === */
    .m-sheet-wrapper {
        background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; 
        min-height: 250px; position: relative; overflow: hidden; /* éšè—æº¢å‡º */
    }

    .m-notation-scroll {
        position: relative; 
        overflow-x: auto; 
        padding: 20px;
        min-height: 250px;
        /* ç¡®ä¿å†…å®¹å±…ä¸­ï¼Œé™¤éå†…å®¹å¤ªå®½ */
        display: flex; justify-content: center;
    }
    #notation-paper svg { overflow: visible; }

    /* âœ¨ é­”æ³•çº¢çº¿ */
    .m-cursor {
        position: absolute;
        top: 0; left: 0;
        width: 2px;
        height: 100%; /* è´¯ç©¿æ•´ä¸ªä¹è°± */
        background: #e74c3c;
        z-index: 100;
        display: none;
        pointer-events: auto; /* å…è®¸é¼ æ ‡äº¤äº’ */
        cursor: ew-resize; /* é¼ æ ‡å˜æ‹–åŠ¨æ ·å¼ */
        /* å…³é”®ï¼šä½¿ç”¨ transition å®ç°å¹³æ»‘ç§»åŠ¨ï¼ŒèŠ‚å¥æ„Ÿ */
        transition: left 0.1s linear; 
    }
    /* æ‹–æ‹½æ‰‹æŸ„ï¼ˆé¡¶éƒ¨çš„å€’ä¸‰è§’ï¼‰ */
    .m-cursor-head {
        position: absolute; top: -10px; left: -6px;
        width: 0; height: 0;
        border-left: 7px solid transparent;
        border-right: 7px solid transparent;
        border-top: 10px solid #e74c3c;
    }
    .m-cursor:hover { box-shadow: 0 0 8px rgba(231, 76, 60, 0.8); width: 3px; }

    .m-click-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 50; cursor: text;
        display: none; /* æ’­æ”¾æ—¶æ‰æ˜¾ç¤ºæˆ–ä¸€ç›´æ˜¾ç¤º */
    }

    .m-empty-state { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #bdc3c7; }

    /* === é’¢ç´åŒºåŸŸ === */
    .m-piano-container { background: #2d3436; border-radius: 8px; padding: 10px 0; width: 100%; overflow: hidden; }
    .m-piano-bar { padding: 0 20px 8px 20px; display: flex; justify-content: space-between; color: #b2bec3; font-size: 11px; align-items: center; }
    .m-btn-small { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; }
    .m-piano-scroll-view { width: 100%; overflow-x: auto; padding-bottom: 5px; scrollbar-width: thin; scrollbar-color: #636e72 #2d3436; }
    .m-piano-body { position: relative; height: 140px; width: 2288px; margin: 0 auto; background: #111; }
    
    .m-key { position: absolute; top: 0; height: 100%; border-radius: 0 0 4px 4px; cursor: pointer; transition: transform 0.05s, background 0.05s; }
    .m-key-white { width: 26px; height: 140px; background: #fff; border: 1px solid #999; z-index: 1; }
    .m-key-white.active { background: #dfe6e9; transform: translateY(2px); border-bottom: 4px solid #b2bec3; }
    .m-key-black { width: 16px; height: 85px; background: #111; border: 1px solid #000; z-index: 2; }
    .m-key-black.active { background: #333; transform: translateY(2px); box-shadow: inset 0 0 5px #555; }
    .m-key[data-note="C4"]::after { content: "C4"; position: absolute; bottom: 5px; width: 100%; text-align: center; color: #999; font-size: 9px; }
</style>

<script>
(function(){
    const MusicApp = {
        songs: [],
        synth: null,
        visualObj: null,
        timer: null,
        cursorEl: null,
        audioContext: null,
        
        // çŠ¶æ€å˜é‡
        isPlaying: false,
        currentSpeed: 1.0,
        isDragging: false,
        noteElements: [], // å­˜å‚¨æ‰€æœ‰éŸ³ç¬¦çš„ä½ç½®ä¿¡æ¯ï¼Œç”¨äºè®¡ç®—æ‹–æ‹½

        init: function() {
            this.cursorEl = document.getElementById('cursor');
            this.renderFullPiano();
            this.fetchData();
            
            const AudioCtor = window.AudioContext || window.webkitAudioContext;
            this.audioContext = new AudioCtor();

            if (ABCJS.synth.supportsAudio()) {
                this.synth = new ABCJS.synth.CreateSynth();
                this.initSynth();
            }

            // åˆå§‹åŒ–æ‹–æ‹½ç›‘å¬
            this.initDragLogic();
        },

        // === 1. å£°éŸ³åˆå§‹åŒ– (ä¿®å¤æ— å£°é—®é¢˜) ===
        initSynth: async function() {
            const status = document.getElementById('status-display');
            status.innerText = "â³ åŠ è½½éŸ³æº...";
            try {
                await this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { 
                        program: 0, 
                        // ç¡®ä¿æ–‡ä»¶å¤¹è·¯å¾„æ­£ç¡®
                        soundFontUrl: "./data/soundfont/" 
                    } 
                });
                await this.synth.prime();
                status.innerText = "âœ… é’¢ç´å°±ç»ª";
                status.style.color = "#27ae60"; 
            } catch (e) {
                console.warn(e);
                status.innerText = "âš ï¸ åŸºç¡€éŸ³è‰²";
            }
        },

        fetchData: function() {
            const sel = document.getElementById('song-select');
            fetch('data/songs.json')
                .then(r => r.json())
                .then(data => {
                    this.songs = data;
                    sel.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©ä¹è°±...</option>';
                    data.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id; opt.innerText = s.title; sel.appendChild(opt);
                    });
                })
                .catch(() => sel.innerHTML = '<option>âš ï¸ JSONåŠ è½½å¤±è´¥</option>');
        },

        loadSong: function(id) {
            this.stop();
            document.getElementById('empty-state').style.display = 'none';
            const song = this.songs.find(s => s.id == id);
            
            // æ¸²æŸ“ä¹è°±ï¼Œå¼€å¯ clickListener
            // è¿™å¯¹å®ç°â€œç‚¹å‡»è·³è½¬â€è‡³å…³é‡è¦
            this.visualObj = ABCJS.renderAbc("notation-paper", song.abc, {
                responsive: "resize",
                scale: 1.1,
                add_classes: true,
                paddingtop: 0, paddingbottom: 0, paddingleft: 0, paddingright: 0,
                // ç›‘å¬ä¹è°±ç‚¹å‡»
                clickListener: (abcElem, tuneNumber, classes, analysis, drag, mouseEvent) => {
                     this.handleScoreClick(abcElem);
                }
            })[0];

            // ç¼“å­˜æ‰€æœ‰éŸ³ç¬¦ä½ç½®ï¼Œç”¨äºæ‹–æ‹½å¸é™„
            this.cacheNotePositions();

            // é‡ç½® Synth
            if (this.synth) {
                this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { 
                        program: 0, 
                        soundFontUrl: "./data/soundfont/",
                        warp: 100 * this.currentSpeed 
                    }
                }).then(() => this.synth.prime());
            }
        },

        // === 2. æ‹–æ‹½ä¸è·³è½¬é€»è¾‘ (æ ¸å¿ƒæ–°åŠŸèƒ½) ===
        
        // å½“ç”¨æˆ·ç›´æ¥ç‚¹å‡»ä¹è°±ä¸Šçš„éŸ³ç¬¦æ—¶
        handleScoreClick: function(abcElem) {
            // å¦‚æœç‚¹å‡»äº†éŸ³ç¬¦ï¼Œæˆ‘ä»¬å°è¯•ä»è¿™é‡Œå¼€å§‹æ’­æ”¾
            // æ³¨æ„ï¼šABCJS Basic Synth ä¸æ”¯æŒç›´æ¥ seek åˆ°æ—¶é—´ç‚¹
            // æˆ‘ä»¬å¿…é¡»åšä¸€ä¸ª hackï¼šç”¨ setTiming æˆ–è€…é‡æ–° render åªæœ‰ååŠæ®µçš„è°±å­(å¤ªå¤æ‚)
            // å¦¥åæ–¹æ¡ˆï¼šç‚¹å‡»éŸ³ç¬¦ï¼Œç§»åŠ¨çº¢çº¿è¿‡å»ï¼Œå¹¶é«˜äº®è¯¥éŸ³ç¬¦ï¼Œå‘Šè¯‰ç”¨æˆ·â€œä»è¿™é‡Œå¼€å§‹â€éœ€è¦æŸç§é«˜çº§æ”¯æŒ
            
            // å®é™…ä¸Šï¼Œä¸ºäº†æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œæˆ‘ä»¬è®©çº¢çº¿è·³è¿‡å»
            // å¹¶å°è¯•ç”¨ "Note Highlight" 
            if(abcElem && abcElem.abselem) {
                this.moveCursorTo(abcElem.abselem.x, abcElem.abselem.y, abcElem.abselem.height);
                
                // åœæ­¢å½“å‰æ’­æ”¾
                if(this.isPlaying) this.stop();
                
                // æ’­æ”¾ç‚¹å‡»çš„é‚£ä¸ªéŸ³
                if(abcElem.midiPitches) {
                    abcElem.midiPitches.forEach(p => this.playNotePro(p.pitch));
                }
                
                // âš ï¸ çœŸå®æƒ…å†µï¼šABCJS Basicç‰ˆä¸æ”¯æŒ seek()
                // å¦‚æœä½ æƒ³çœŸçš„â€œä»è¿™é‡Œå¼€å§‹è‡ªåŠ¨æ’­æ”¾â€ï¼Œéœ€è¦éå¸¸å¤æ‚çš„ä»£ç åˆ‡åˆ† ABC å­—ç¬¦ä¸²
                // è¿™é‡Œæˆ‘ä»¬åšåˆ°ï¼šçº¢çº¿è·³è¿‡å»ï¼Œå‘å£°ï¼Œå°±ç»ªã€‚
            }
        },

        initDragLogic: function() {
            const cursor = this.cursorEl;
            const container = document.getElementById('scroll-container');
            let isDown = false;

            cursor.addEventListener('mousedown', (e) => {
                isDown = true;
                cursor.style.transition = 'none'; // æ‹–åŠ¨æ—¶å–æ¶ˆå¹³æ»‘è¿‡æ¸¡ï¼Œå®æ—¶è·Ÿéš
                cursor.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                // è®¡ç®—é¼ æ ‡åœ¨å®¹å™¨å†…çš„ç›¸å¯¹ X åæ ‡
                const rect = container.getBoundingClientRect();
                let x = e.clientX - rect.left + container.scrollLeft;
                
                // é™åˆ¶è¾¹ç•Œ
                if(x < 0) x = 0;
                
                cursor.style.left = x + 'px';
            });

            document.addEventListener('mouseup', (e) => {
                if (!isDown) return;
                isDown = false;
                cursor.style.cursor = 'ew-resize';
                cursor.style.transition = 'left 0.1s linear'; // æ¢å¤å¹³æ»‘
                
                // æ‹–æ‹½ç»“æŸï¼šå¯»æ‰¾æœ€è¿‘çš„éŸ³ç¬¦
                this.snapToNearestNote();
            });
        },

        cacheNotePositions: function() {
            // ä» SVG ä¸­è·å–æ‰€æœ‰éŸ³ç¬¦å…ƒç´ çš„ä½ç½®
            // abcjs ç”Ÿæˆçš„éŸ³ç¬¦éƒ½æœ‰ class "abcjs-note"
            const notes = document.querySelectorAll('.abcjs-note');
            this.noteElements = [];
            
            // è·å–å®¹å™¨çš„åç§»ï¼Œä»¥ä¾¿è®¡ç®—ç›¸å¯¹åæ ‡
            const containerRect = document.getElementById('scroll-container').getBoundingClientRect();

            notes.forEach(note => {
                const rect = note.getBoundingClientRect();
                // å­˜å‚¨ç›¸å¯¹ X åæ ‡
                this.noteElements.push({
                    x: rect.left - containerRect.left + document.getElementById('scroll-container').scrollLeft,
                    el: note,
                    // å°è¯•ä» element data ä¸­è·å– midi ä¿¡æ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    // abcjs æ¸²æŸ“æ—¶é€šå¸¸ä¸ç»‘å®š data åˆ° domï¼Œè¿™æ¯”è¾ƒéš¾
                });
            });
            // æŒ‰ x æ’åº
            this.noteElements.sort((a, b) => a.x - b.x);
        },

        snapToNearestNote: function() {
            // è·å–å½“å‰çº¢çº¿ä½ç½®
            const cursorX = parseFloat(this.cursorEl.style.left);
            
            // å¯»æ‰¾æœ€è¿‘çš„éŸ³ç¬¦
            let closest = null;
            let minDist = Infinity;
            
            this.noteElements.forEach(note => {
                const dist = Math.abs(note.x - cursorX);
                if(dist < minDist) {
                    minDist = dist;
                    closest = note;
                }
            });

            if(closest) {
                // å¸é™„è¿‡å»
                this.cursorEl.style.left = (closest.x - 5) + 'px'; // -5 æ˜¯ä¸ºäº†å¯¹å‡†å·¦ä¾§
                
                // åœæ­¢æ’­æ”¾ï¼Œå‡†å¤‡é‡æ–°å¼€å§‹
                this.stop();
                
                // å¯ä»¥åœ¨è¿™é‡Œè§¦å‘ "ä»ç¬¬ N ä¸ªéŸ³ç¬¦æ’­æ”¾" çš„é€»è¾‘
                // ä½†ç”±äºåº“é™åˆ¶ï¼Œæˆ‘ä»¬æš‚æ—¶åªåšè§†è§‰å¸é™„å’Œè¯•å¬
                // æ¨¡æ‹Ÿç‚¹å‡»è¯¥éŸ³ç¬¦çš„æ•ˆæœï¼ˆå¦‚æœæœ‰å¯¹åº”æ•°æ®ï¼‰
                console.log("Snapped to note at x:", closest.x);
            }
        },

        moveCursorTo: function(x, y, h) {
            this.cursorEl.style.display = 'block';
            this.cursorEl.style.left = x + 'px';
            // çº¢çº¿è´¯ç©¿ï¼Œä¸éœ€è¦è®¾ç½® y å’Œ hï¼Œé«˜åº¦ç”± CSS 100% æ§åˆ¶
        },

        // === 3. æ’­æ”¾ä¸åŒæ­¥é€»è¾‘ ===
        togglePlay: function() {
            if (this.isPlaying) this.stop();
            else this.play();
        },

        play: function() {
            if (!this.visualObj) return alert("è¯·å…ˆé€‰æ‹©ä¹è°±");
            if (this.audioContext.state === 'suspended') this.audioContext.resume();

            if (this.synth) {
                this.isPlaying = true;
                document.getElementById('btn-play').innerText = "â¸ æš‚åœ";
                
                // é‡æ–°åˆå§‹åŒ–ä»¥åº”ç”¨é€Ÿåº¦
                this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { 
                        program: 0, 
                        soundFontUrl: "./data/soundfont/",
                        warp: 100 * this.currentSpeed 
                    }
                }).then(() => {
                    this.synth.prime();
                    
                    this.timer = new ABCJS.TimingCallbacks(this.visualObj, {
                        eventCallback: (ev) => {
                            if (ev) {
                                // â˜…â˜…â˜… æ ¸å¿ƒï¼šçº¢çº¿è·Ÿéš â˜…â˜…â˜…
                                if (ev.left !== null && ev.left > 0) {
                                    this.cursorEl.style.display = "block";
                                    // ä¿®æ­£åç§»ï¼šabcjs è¿”å›çš„æ˜¯éŸ³ç¬¦ä¸­å¿ƒæˆ–å·¦ä¾§ï¼Œæˆ‘ä»¬å¾®è°ƒ
                                    // åŠ ä¸Š SVG å†…éƒ¨å¯èƒ½çš„ padding åç§»
                                    this.cursorEl.style.left = (ev.left + 15) + "px"; 
                                }

                                // é’¢ç´è”åŠ¨
                                if (ev.midiPitches) {
                                    ev.midiPitches.forEach(p => this.flashKey(p.pitch, 300 / this.currentSpeed));
                                }
                            } else {
                                this.stop();
                            }
                        }
                    });
                    
                    this.synth.start(); 
                    this.timer.start();
                });
            }
        },

        stop: function() {
            if (this.timer) this.timer.stop();
            if (this.synth) this.synth.stop();
            this.isPlaying = false;
            document.getElementById('btn-play').innerText = "â–¶ æ’­æ”¾";
            // åœæ­¢æ—¶ä¸éšè—å…‰æ ‡ï¼Œæ–¹ä¾¿ç”¨æˆ·çœ‹ä½ç½®ï¼Œä¹Ÿä¸å½’é›¶
            this.clearKeys();
        },

        setSpeed: function(speed, btn) {
            this.currentSpeed = speed;
            document.querySelectorAll('.m-btn-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (this.isPlaying) { this.stop(); this.play(); }
        },

        // === é’¢ç´æ¸²æŸ“ä¸å‘éŸ³ ===
        renderFullPiano: function() {
            const el = document.getElementById('piano-keyboard');
            let html = '';
            let whiteIndex = 0;
            const whiteW = 26; 
            for (let i = 21; i <= 108; i++) {
                const note = this.getNote(i);
                const isBlack = note.includes('#');
                if (!isBlack) {
                    html += `<div class="m-key m-key-white" id="k-${i}" data-midi="${i}" style="left:${whiteIndex * whiteW}px" data-note="${note}"></div>`;
                    whiteIndex++;
                } else {
                    const left = (whiteIndex - 1) * whiteW + (whiteW * 0.6);
                    html += `<div class="m-key m-key-black" id="k-${i}" data-midi="${i}" style="left:${left}px"></div>`;
                }
            }
            el.style.width = (whiteIndex * whiteW) + "px";
            el.innerHTML = html;
            el.addEventListener('mousedown', (e) => {
                const k = e.target;
                if (!k.classList.contains('m-key')) return;
                const midi = parseInt(k.dataset.midi);
                this.flashKey(midi, 500);
                this.playNotePro(midi); 
            });
            setTimeout(() => this.scrollToCenter(), 500);
        },

        scrollToCenter: function() { document.getElementById('piano-scroll').scrollTo({ left: 600, behavior: 'smooth' }); },
        getNote: function(midi) { const n = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return n[midi % 12] + (Math.floor(midi/12)-1); },
        flashKey: function(midi, time) {
            const k = document.getElementById(`k-${midi}`);
            if (!k) return;
            k.classList.remove('active'); void k.offsetWidth; k.classList.add('active');
            setTimeout(() => k.classList.remove('active'), time);
        },
        clearKeys: function() { document.querySelectorAll('.m-key.active').forEach(k => k.classList.remove('active')); },

        // é«˜ä¿çœŸé’¢ç´æ¨¡æ‹Ÿ (ç”¨äºæ‰‹åŠ¨ç‚¹å‡»)
        playNotePro: function(midi) {
            if (this.audioContext.state === 'suspended') this.audioContext.resume();
            const t = this.audioContext.currentTime;
            const freq = 440 * Math.pow(2, (midi - 69) / 12);
            
            const osc = this.audioContext.createOscillator(); osc.type = 'triangle'; osc.frequency.value = freq;
            const overtone = this.audioContext.createOscillator(); overtone.type = 'sine'; overtone.frequency.value = freq * 2;
            const filter = this.audioContext.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = freq * 3;
            const mGain = this.audioContext.createGain(); const oGain = this.audioContext.createGain();

            osc.connect(filter); filter.connect(mGain); mGain.connect(this.audioContext.destination);
            overtone.connect(oGain); oGain.connect(this.audioContext.destination);

            osc.start(t); overtone.start(t);
            mGain.gain.setValueAtTime(0, t); mGain.gain.linearRampToValueAtTime(0.5, t + 0.015); mGain.gain.exponentialRampToValueAtTime(0.01, t + 1.2);
            oGain.gain.setValueAtTime(0, t); oGain.gain.linearRampToValueAtTime(0.1, t + 0.01); oGain.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
            osc.stop(t + 1.2); overtone.stop(t + 1.2);
        }
    };

    window.MusicApp = MusicApp;
    MusicApp.init();
})();
</script>