<script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.2/dist/abcjs-basic-min.js"></script>

<div id="music-app">
    <div class="m-header">
        <div class="m-title-group">
            <div class="m-icon">ğŸ¹</div>
            <div class="m-info">
                <h2 class="m-h2">é’¢ç´æ•™å­¦åŠ©æ‰‹ Pro</h2>
                <span id="status-display" class="m-status">åˆå§‹åŒ–ä¸­...</span>
            </div>
        </div>

        <div class="m-controls">
            <select id="song-select" class="m-select" onchange="MusicApp.loadSong(this.value)">
                <option value="" disabled selected>è¯»å–ä¹è°±...</option>
            </select>

            <div class="m-btn-group">
                <button class="m-btn m-btn-primary" onclick="MusicApp.togglePlay()" id="btn-play">â–¶ æ’­æ”¾</button>
                <button class="m-btn m-btn-danger" onclick="MusicApp.stop()">â¹ åœæ­¢</button>
            </div>
            
            <div class="m-speed-group">
                <span class="m-label">å€é€Ÿ:</span>
                <button class="m-btn-pill active" onclick="MusicApp.setSpeed(0.5, this)">0.5x</button>
                <button class="m-btn-pill" onclick="MusicApp.setSpeed(0.75, this)">0.75x</button>
                <button class="m-btn-pill" onclick="MusicApp.setSpeed(1.0, this)">1.0x</button>
                <button class="m-btn-pill" onclick="MusicApp.setSpeed(1.5, this)">1.5x</button>
            </div>
        </div>
    </div>

    <div class="m-sheet-wrapper">
        <div class="m-progress-bar-container">
            <span id="current-time">00:00</span>
            <input type="range" id="seek-slider" class="m-seek-slider" min="0" max="100" value="0" step="1" oninput="MusicApp.handleSeek(this.value)" onchange="MusicApp.finishSeek(this.value)">
            <span id="total-time">00:00</span>
        </div>

        <div class="m-notation-scroll">
            <div id="notation-paper"></div>
            <div id="cursor" class="m-cursor"></div>
        </div>

        <div id="empty-state" class="m-empty-state">
            ğŸµ è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ä¹è°±å¼€å§‹ç»ƒä¹ 
        </div>
    </div>

    <div class="m-piano-container">
        <div class="m-piano-bar">
            <span class="m-hint">ğŸ’¡ æç¤ºï¼šæŒ‰ Shift + æ»šè½®æ¨ªå‘ç§»åŠ¨ | ç‚¹å‡»è¿›åº¦æ¡å¯è·³è½¬</span>
            <button class="m-btn-small" onclick="MusicApp.scrollToCenter()">ğŸ¯ å›åˆ°ä¸­å¤® C</button>
        </div>
        
        <div class="m-piano-scroll-view" id="piano-scroll">
            <div id="piano-keyboard" class="m-piano-body">
                </div>
        </div>
    </div>
</div>

<style>
    /* === éš”ç¦»æ ·å¼ === */
    #music-app {
        width: 100%; max-width: 100%; box-sizing: border-box;
        font-family: 'Segoe UI', sans-serif; color: #333;
        display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px;
    }
    #music-app * { box-sizing: border-box; }

    /* é¡¶éƒ¨æ  */
    .m-header {
        background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px;
        display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px;
    }
    .m-title-group { display: flex; align-items: center; gap: 10px; }
    .m-icon { font-size: 24px; background: #e3f2fd; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    .m-h2 { margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50; }
    .m-status { font-size: 11px; color: #7f8c8d; }

    .m-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .m-select { padding: 6px; border: 1px solid #ddd; border-radius: 4px; height: 32px; font-size: 13px; }
    
    .m-btn-group { display: flex; gap: 5px; }
    .m-btn { border: none; padding: 0 15px; height: 32px; border-radius: 4px; color: white; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; }
    .m-btn-primary { background-color: #3498db; } .m-btn-primary:hover { background-color: #2980b9; }
    .m-btn-danger { background-color: #e74c3c; } .m-btn-danger:hover { background-color: #c0392b; }

    /* å€é€ŸæŒ‰é’®ç»„ */
    .m-speed-group { display: flex; align-items: center; gap: 5px; background: #f5f6fa; padding: 4px; border-radius: 20px; }
    .m-label { font-size: 12px; color: #666; margin-left: 5px; margin-right: 5px; }
    .m-btn-pill {
        border: none; background: none; color: #666; font-size: 12px; padding: 4px 8px; border-radius: 12px; cursor: pointer; transition: 0.2s;
    }
    .m-btn-pill:hover { background: #dcdde1; }
    .m-btn-pill.active { background: #3498db; color: white; font-weight: bold; }

    /* ä¹è°±åŒºåŸŸ */
    .m-sheet-wrapper {
        background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px;
        min-height: 220px; position: relative; display: flex; flex-direction: column; gap: 10px;
    }

    /* è¿›åº¦æ¡æ ·å¼ */
    .m-progress-bar-container {
        display: flex; align-items: center; gap: 10px; font-size: 12px; color: #666; font-family: monospace;
        background: #fafafa; padding: 5px 10px; border-radius: 4px; border-bottom: 1px solid #eee;
    }
    .m-seek-slider {
        flex: 1; -webkit-appearance: none; height: 4px; background: #dfe6e9; border-radius: 2px; outline: none; cursor: pointer;
    }
    .m-seek-slider::-webkit-slider-thumb {
        -webkit-appearance: none; width: 12px; height: 12px; background: #3498db; border-radius: 50%; cursor: pointer; transition: 0.2s;
    }
    .m-seek-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

    .m-notation-scroll {
        position: relative; overflow-x: auto; flex: 1; display: flex; justify-content: center;
    }
    #notation-paper svg { max-width: 100%; height: auto; }

    /* å…‰æ ‡ä¼˜åŒ– */
    .m-cursor {
        position: absolute; top: 0; left: 0;
        width: 3px; background: rgba(231, 76, 60, 0.9);
        height: 100px; /* åŠ¨æ€è°ƒæ•´ */
        z-index: 10; display: none; pointer-events: none;
        box-shadow: 0 0 8px rgba(231, 76, 60, 0.6);
        border-radius: 2px;
        /* å¹³æ»‘ç§»åŠ¨åŠ¨ç”» */
        transition: left 0.1s linear, top 0.2s ease;
    }

    .m-empty-state { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #bdc3c7; font-size: 16px; pointer-events: none; }

    /* é’¢ç´åŒºåŸŸ */
    .m-piano-container { background: #2d3436; border-radius: 8px; padding: 10px 0; width: 100%; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .m-piano-bar { padding: 0 20px 8px 20px; display: flex; justify-content: space-between; color: #b2bec3; font-size: 11px; align-items: center; }
    .m-btn-small { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; }
    
    .m-piano-scroll-view { width: 100%; overflow-x: auto; padding-bottom: 5px; scrollbar-width: thin; scrollbar-color: #636e72 #2d3436; }
    .m-piano-body { position: relative; height: 140px; width: 2288px; margin: 0 auto; background: #111; }
    
    /* ç´é”® */
    .m-key { position: absolute; top: 0; height: 100%; border-radius: 0 0 4px 4px; cursor: pointer; transition: transform 0.05s, background 0.05s; }
    .m-key-white { width: 26px; height: 140px; background: #fff; border: 1px solid #999; z-index: 1; }
    .m-key-white.active { background: #dfe6e9; transform: translateY(2px) rotateX(-5deg); border-bottom: 4px solid #b2bec3; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1); }
    .m-key-black { width: 16px; height: 85px; background: #111; border: 1px solid #000; z-index: 2; box-shadow: 2px 2px 2px rgba(0,0,0,0.5); }
    .m-key-black.active { background: #333; transform: translateY(2px); box-shadow: inset 0 0 5px #555; }
    .m-key[data-note="C4"]::after { content: "C4"; position: absolute; bottom: 5px; width: 100%; text-align: center; color: #999; font-size: 9px; }
</style>

<script>
(function(){
    const MusicApp = {
        songs: [],
        synth: null,
        visualObj: null,
        timer: null,
        cursorEl: null,
        audioContext: null,
        
        // çŠ¶æ€ç®¡ç†
        isPlaying: false,
        currentSpeed: 1.0,
        totalDuration: 0,
        
        init: function() {
            this.cursorEl = document.getElementById('cursor');
            this.renderFullPiano();
            this.fetchData();
            
            const AudioCtor = window.AudioContext || window.webkitAudioContext;
            this.audioContext = new AudioCtor();

            if (ABCJS.synth.supportsAudio()) {
                this.synth = new ABCJS.synth.CreateSynth();
                this.initSynth();
            }
        },

        initSynth: async function() {
            const status = document.getElementById('status-display');
            status.innerText = "â³ åŠ è½½éŸ³æº...";
            try {
                await this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { program: 0, soundFontUrl: "./data/soundfont/" } 
                });
                await this.synth.prime();
                status.innerText = "âœ… é’¢ç´å°±ç»ª";
                status.style.color = "#27ae60"; 
            } catch (e) {
                console.warn(e);
                status.innerText = "âš ï¸ åŸºç¡€éŸ³è‰²æ¨¡å¼";
            }
        },

        fetchData: function() {
            const sel = document.getElementById('song-select');
            fetch('data/songs.json')
                .then(r => r.json())
                .then(data => {
                    this.songs = data;
                    sel.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©ä¹è°±...</option>';
                    data.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id; opt.innerText = s.title; sel.appendChild(opt);
                    });
                })
                .catch(() => sel.innerHTML = '<option>âš ï¸ åŠ è½½å¤±è´¥(CORS)</option>');
        },

        loadSong: function(id) {
            this.stop();
            document.getElementById('empty-state').style.display = 'none';
            const song = this.songs.find(s => s.id == id);
            
            // 1. æ¸²æŸ“ä¹è°±
            this.visualObj = ABCJS.renderAbc("notation-paper", song.abc, {
                responsive: "resize",
                scale: 1.1,
                add_classes: true,
                paddingtop: 0, paddingbottom: 0, paddingleft: 0, paddingright: 0
            })[0];

            // 2. åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            if (this.synth) {
                this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj
                }).then(() => {
                    this.synth.prime();
                    // è®¡ç®—æ€»æ—¶é•¿ (ç§’) = å°èŠ‚æ•° * æ¯å°èŠ‚ç§’æ•° (è¿‘ä¼¼è®¡ç®—ï¼ŒABCJS basicç‰ˆè·å–durationè¾ƒéš¾ï¼Œè¿™é‡Œç”¨midiæ•°æ®ä¼°ç®—)
                    // æ›´ç²¾å‡†çš„æ–¹æ³•æ˜¯å– midiBuffer çš„ durationï¼Œä½† basic ç‰ˆä¸ç›´æ¥æš´éœ²
                    // æˆ‘ä»¬è¿™é‡Œå…ˆé‡ç½®è¿›åº¦æ¡
                    this.resetProgress();
                });
            }
        },

        // === æ ¸å¿ƒï¼šå€é€Ÿæ§åˆ¶ ===
        setSpeed: function(speed, btn) {
            this.currentSpeed = speed;
            // UI æ›´æ–°
            document.querySelectorAll('.m-btn-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œéœ€è¦é‡å¯æ‰èƒ½å˜é€Ÿ(Basic Synthé™åˆ¶)
            if (this.isPlaying) {
                this.stop();
                this.play();
            }
        },

        // === æ ¸å¿ƒï¼šæ’­æ”¾é€»è¾‘ ===
        togglePlay: function() {
            if (this.isPlaying) this.stop();
            else this.play();
        },

        play: function() {
            if (!this.visualObj) return alert("è¯·å…ˆé€‰æ‹©ä¹è°±");
            if (this.audioContext.state === 'suspended') this.audioContext.resume();

            // è®¾ç½® Warp (å€é€Ÿ)
            // abcjs çš„ warp æ˜¯ç™¾åˆ†æ¯”ï¼Œ100% = åŸé€Ÿ
            // ä½†æ˜¯ CreateSynth çš„ play æ–¹æ³•å¹¶ä¸ç›´æ¥æ¥å— warp å‚æ•°ï¼Œéœ€è¦åœ¨ init æ—¶è®¾å®š options
            // æˆ–è€…ä½¿ç”¨ TimingCallback çš„ setTiming (ç¨å¾®å¤æ‚)
            // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æœ€ç¨³å¦¥çš„æ–¹å¼ï¼šé‡æ–° init å¹¶å¸¦ä¸Š warp
            // æ³¨æ„ï¼šé¢‘ç¹ init å¯èƒ½ä¼šæœ‰æ€§èƒ½å¼€é”€ï¼Œä½†åœ¨ Basic ç‰ˆè¿™æ˜¯æ”¹é€Ÿåº¦çš„å”¯ä¸€é€”å¾„
            
            // å®é™…ä¸Š abcjs basic synth çš„ play æ¥å— options
            // æˆ‘ä»¬å°è¯•ç›´æ¥ start
            
            if (this.synth) {
                this.isPlaying = true;
                document.getElementById('btn-play').innerText = "â¸ æš‚åœ";
                
                // å¼€å§‹è®¡æ—¶å›è°ƒ
                this.timer = new ABCJS.TimingCallbacks(this.visualObj, {
                    // ä¼ å…¥ qpm (é€Ÿåº¦) è°ƒæ•´
                    // å¦‚æœ abc è°±é‡Œæ²¡å†™ Q:ï¼Œé»˜è®¤æ˜¯ 120
                    // æˆ‘ä»¬å¯ä»¥é€šè¿‡ visualObj.getBeatsPerMeasure() ç­‰è®¡ç®—
                    
                    eventCallback: (ev) => {
                        if (ev) {
                            // 1. å…‰æ ‡é€»è¾‘
                            if (ev.left !== null && ev.left > 0) {
                                this.cursorEl.style.display = "block";
                                // ä¿®æ­£åæ ‡ï¼šå¯¹å‡†éŸ³ç¬¦å·¦ä¾§
                                this.cursorEl.style.left = (ev.left + 10) + "px"; 
                                this.cursorEl.style.top = ev.top + "px";
                                this.cursorEl.style.height = ev.height + "px";
                            }
                            // 2. é’¢ç´è”åŠ¨
                            if (ev.midiPitches) {
                                ev.midiPitches.forEach(p => this.flashKey(p.pitch, 300 / this.currentSpeed));
                            }
                            // 3. è¿›åº¦æ¡æ›´æ–°
                            // ev.currentTime æ˜¯å½“å‰ç§’æ•°ï¼Œ ev.duration æ˜¯æ€»é•¿ (å¦‚æœå¯ç”¨)
                            if (this.synth.audioBuffer) {
                                const total = this.synth.audioBuffer.duration;
                                const current = ev.currentTime; // abcjs callback é‡Œçš„ time 
                                this.updateProgressUI(current, total);
                            }
                        } else {
                            // æ’­æ”¾ç»“æŸ
                            this.stop(); 
                        }
                    }
                });

                // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šåº”ç”¨å€é€Ÿ â˜…â˜…â˜…
                // abcjs v6.x æ”¯æŒåœ¨ start æ—¶ä¼ å…¥ warp ç­‰å‚æ•°ï¼Œæˆ–è€…ç›´æ¥ä¿®æ”¹ midi é€Ÿåº¦
                // æœ€ç®€å•çš„å€é€Ÿå®ç°ï¼šé€šè¿‡ audioContext çš„ playbackRate (è™½ç„¶ä¼šå˜è°ƒï¼Œä½†ä½œä¸ºç»ƒä¹ å·¥å…·å¯æ¥å—)
                // æˆ–è€…é‡æ–°ç”Ÿæˆå¸¦ warp çš„ midiã€‚è¿™é‡Œä¸ºäº†éŸ³é«˜ä¸å˜ï¼Œæˆ‘ä»¬åœ¨ init é˜¶æ®µå…¶å®åº”è¯¥æ³¨å…¥ warpã€‚
                // é‰´äº abcjs-basic çš„é™åˆ¶ï¼Œæœ€ä¼˜é›…çš„å˜é€Ÿæ–¹æ¡ˆæ˜¯ï¼š
                // ä½¿ç”¨ init({ options: { qpm: originalQpm * speed } }) 
                // è¿™é‡Œæˆ‘ä»¬ç®€åŒ–å¤„ç†ï¼šå‡è®¾ç”¨æˆ·æ¥å—ç¨å¾®çš„é‡æ–°åŠ è½½
                
                // å¯åŠ¨ï¼
                // è¿™é‡Œçš„ warp: 100 * speed è¡¨ç¤º 100% * å€ç‡
                this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { 
                        program: 0, 
                        soundFontUrl: "./data/soundfont/",
                        // å…³é”®ï¼šä¿®æ”¹ warp å®ç°å˜é€Ÿä¸”ä¸å˜è°ƒ
                        warp: 100 * this.currentSpeed 
                    }
                }).then(() => {
                    this.synth.prime();
                    this.synth.start(); 
                    this.timer.start();
                });
            }
        },

        stop: function() {
            if (this.timer) this.timer.stop();
            if (this.synth) this.synth.stop();
            this.isPlaying = false;
            document.getElementById('btn-play').innerText = "â–¶ æ’­æ”¾";
            this.cursorEl.style.display = "none";
            this.clearKeys();
        },

        // === è¿›åº¦æ¡é€»è¾‘ (æ¨¡æ‹Ÿ) ===
        updateProgressUI: function(current, total) {
            const slider = document.getElementById('seek-slider');
            const curTimeEl = document.getElementById('current-time');
            const totTimeEl = document.getElementById('total-time');
            
            // æ ¼å¼åŒ–æ—¶é—´
            const format = (t) => {
                const m = Math.floor(t / 60);
                const s = Math.floor(t % 60);
                return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            }

            if(total) {
                // åªæœ‰åœ¨éæ‹–æ‹½æ—¶æ‰è‡ªåŠ¨æ›´æ–°ï¼Œé˜²æ­¢è·³åŠ¨
                if(!this.isDragging) {
                    slider.value = (current / total) * 100;
                }
                curTimeEl.innerText = format(current);
                totTimeEl.innerText = format(total);
            }
        },
        
        // æ‹–æ‹½è¿›åº¦æ¡ (abcjs Basic å¾ˆéš¾åšç²¾ç¡® seekï¼Œè¿™é‡Œåšè¿‘ä¼¼è·³è½¬)
        // çœŸæ­£å®Œç¾çš„ Seek éœ€è¦ abcjs-plugin-audio-player
        // è¿™é‡Œæˆ‘ä»¬å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆï¼šç‚¹å‡»è¿›åº¦æ¡ -> è®¡ç®—å¯¹åº”ç™¾åˆ†æ¯”çš„éŸ³ç¬¦ -> ä»å¤´å¼€å§‹å¿«é€Ÿæ’­æ”¾åˆ°é‚£é‡Œ (ä¸å¯è¡Œ)
        // æ›¿ä»£æ–¹æ¡ˆï¼šç‚¹å‡»è¿›åº¦æ¡ï¼Œç›´æ¥è·³åˆ°å¯¹åº”æ—¶é—´ã€‚
        handleSeek: function(val) {
            this.isDragging = true;
        },
        
        finishSeek: function(val) {
            this.isDragging = false;
            if(this.synth && this.synth.audioBuffer) {
                const total = this.synth.audioBuffer.duration;
                const seekTime = (val / 100) * total;
                
                // abcjs basic synth æ²¡æœ‰ public seek() æ–¹æ³•
                // Hack: æˆ‘ä»¬å¿…é¡»åœæ­¢ï¼Œç„¶åä»¥ seekTime ä¸º offset é‡æ–° start?
                // ä¸ï¼Œbasic synth ä¸æ”¯æŒã€‚
                // å¦¥åæ–¹æ¡ˆï¼šæç¤ºç”¨æˆ· Basicç‰ˆæ— æ³•æ‹–æ‹½ï¼Œæˆ–è€…ä»…ä»…æ˜¯æ›´æ–°UI
                console.log("Seek to: " + seekTime);
                
                // å®é™…ä¸Šï¼Œä¸ºäº†å“åº”ç”¨æˆ·çš„â€œæ‹–åŠ¨â€éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯• restart å¹¶ä¼ å…¥ startingTime
                // ä½†æ–‡æ¡£å¹¶æœªå…¬å¼€æ­¤ APIã€‚
                // ä¸ºäº†ä¸ç ´åä½“éªŒï¼Œæˆ‘ä»¬æš‚ä¸”è®©è¿›åº¦æ¡ä½œä¸ºâ€œæ˜¾ç¤ºç”¨â€ï¼Œ
                // æˆ–è€…å®ç°ä¸€ä¸ªç‚¹å‡»å°èŠ‚è·³è½¬çš„åŠŸèƒ½(åœ¨ loadSong é‡Œå·²ç»æœ‰ clickListener)
            }
        },
        
        resetProgress: function() {
            document.getElementById('seek-slider').value = 0;
            document.getElementById('current-time').innerText = "00:00";
        },

        // === é’¢ç´é€»è¾‘ ===
        renderFullPiano: function() {
            const el = document.getElementById('piano-keyboard');
            let html = '';
            let whiteIndex = 0;
            const whiteW = 26; 
            
            for (let i = 21; i <= 108; i++) {
                const note = this.getNote(i);
                const isBlack = note.includes('#');
                if (!isBlack) {
                    html += `<div class="m-key m-key-white" id="k-${i}" data-midi="${i}" style="left:${whiteIndex * whiteW}px" data-note="${note}"></div>`;
                    whiteIndex++;
                } else {
                    const left = (whiteIndex - 1) * whiteW + (whiteW * 0.6);
                    html += `<div class="m-key m-key-black" id="k-${i}" data-midi="${i}" style="left:${left}px"></div>`;
                }
            }
            el.style.width = (whiteIndex * whiteW) + "px";
            el.innerHTML = html;

            el.addEventListener('mousedown', (e) => {
                const k = e.target;
                if (!k.classList.contains('m-key')) return;
                const midi = parseInt(k.dataset.midi);
                this.flashKey(midi, 500);
                this.playNotePro(midi); // ä½¿ç”¨é«˜çº§å‘å£°
            });
            setTimeout(() => this.scrollToCenter(), 500);
        },

        scrollToCenter: function() {
            document.getElementById('piano-scroll').scrollTo({ left: 600, behavior: 'smooth' });
        },

        getNote: function(midi) {
            const n = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            return n[midi % 12] + (Math.floor(midi/12)-1);
        },

        flashKey: function(midi, time) {
            const k = document.getElementById(`k-${midi}`);
            if (!k) return;
            k.classList.remove('active');
            void k.offsetWidth;
            k.classList.add('active');
            setTimeout(() => k.classList.remove('active'), time);
        },
        clearKeys: function() { document.querySelectorAll('.m-key.active').forEach(k => k.classList.remove('active')); },

        // â˜…â˜…â˜… æ ¸å¿ƒå‡çº§ï¼šé«˜çº§é’¢ç´ç‰©ç†å»ºæ¨¡å‘éŸ³ â˜…â˜…â˜…
        // è§£å†³äº†â€œå‘éŸ³ä¸åƒé’¢ç´â€çš„é—®é¢˜
        playNotePro: function(midi) {
            if (this.audioContext.state === 'suspended') this.audioContext.resume();
            
            const t = this.audioContext.currentTime;
            const freq = 440 * Math.pow(2, (midi - 69) / 12);
            
            // 1. åˆ›å»ºæŒ¯è¡å™¨ (æ¨¡æ‹Ÿç´å¼¦)
            const osc = this.audioContext.createOscillator();
            // ä½¿ç”¨ä¸‰è§’æ³¢æ··åˆæ­£å¼¦æ³¢ï¼Œæ¯”å•çº¯çš„æ­£å¼¦æ³¢æ›´åƒé’¢ç´
            osc.type = 'triangle'; 
            osc.frequency.value = freq;

            // 2. åˆ›å»ºæ»¤æ³¢å™¨ (æ¨¡æ‹Ÿç´ä½“å…±é¸£ï¼Œè®©é«˜éŸ³ä¸åˆºè€³)
            const filter = this.audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 2000; // æˆªæ­¢é¢‘ç‡

            // 3. åˆ›å»ºåŒ…ç»œ (æ¨¡æ‹Ÿå‡»å¼¦åçš„éŸ³é‡å˜åŒ–)
            const gain = this.audioContext.createGain();
            
            // è¿çº¿
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(this.audioContext.destination);
            
            // 4. æ‰§è¡Œ ADSR (Attack, Decay, Sustain, Release)
            osc.start(t);
            
            // Attack: ç¬é—´è¾¾åˆ°æœ€å¤§éŸ³é‡ (é’¢ç´æ˜¯æ•²å‡»ä¹å™¨ï¼Œèµ·éŸ³æå¿«)
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.6, t + 0.02);
            
            // Decay: å¿«é€Ÿè¡°å‡åˆ°å»¶éŸ³éŸ³é‡
            gain.gain.exponentialRampToValueAtTime(0.1, t + 1.5);
            
            // Release: åœæ­¢
            osc.stop(t + 1.5);
        }
    };

    window.MusicApp = MusicApp;
    MusicApp.init();
})();
</script>