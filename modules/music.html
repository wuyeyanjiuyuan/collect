<div id="music-app">
    <div class="m-header">
        <div class="m-title-group">
            <div class="m-icon">ğŸ¹</div>
            <div class="m-info">
                <h2 class="m-h2">é’¢ç´æ•™å­¦åŠ©æ‰‹</h2>
                <span id="status-display" class="m-status">åˆå§‹åŒ–ä¸­...</span>
            </div>
        </div>

        <div class="m-controls">
            <select id="song-select" class="m-select" onchange="MusicApp.loadSong(this.value)">
                <option value="" disabled selected>æ­£åœ¨è¯»å–ä¹è°±...</option>
            </select>

            <button class="m-btn m-btn-primary" onclick="MusicApp.play()" id="btn-play">â–¶ æ¼”å¥</button>
            <button class="m-btn m-btn-danger" onclick="MusicApp.stop()">â¹ åœæ­¢</button>
            
            <div class="m-speed-box">
                <label>é€Ÿåº¦</label>
                <input type="range" id="tempo-slider" min="30" max="180" value="90" oninput="MusicApp.updateTempo(this.value)">
                <span id="tempo-val">90</span>
            </div>
        </div>
    </div>

    <div class="m-sheet-wrapper">
        <div id="notation-paper"></div>
        <div id="cursor" class="m-cursor"></div>
        <div id="empty-state" class="m-empty-state">
            ğŸµ è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ä¸€é¦–æ›²å­å¼€å§‹
        </div>
    </div>

    <div class="m-piano-container">
        <div class="m-piano-bar">
            <span class="m-hint">ğŸ’¡ æç¤ºï¼šæŒ‰ä½ Shift + æ»šè½®å¯æ¨ªå‘æ»šåŠ¨</span>
            <button class="m-btn-small" onclick="MusicApp.scrollToCenter()">ğŸ¯ å›åˆ°ä¸­å¤® C</button>
        </div>
        
        <div class="m-piano-scroll-view" id="piano-scroll">
            <div id="piano-keyboard" class="m-piano-body">
                </div>
        </div>
    </div>
</div>

<style>
    /* =========================================
       CSS éš”ç¦»å±‚ï¼šæ‰€æœ‰æ ·å¼ä¸¥æ ¼é™åˆ¶åœ¨ #music-app å†…
       ========================================= */
    
    #music-app {
        /* ç¡®ä¿åªå ç”¨çˆ¶å®¹å™¨çš„å®½ï¼Œä¸æ’‘çˆ†é¡µé¢ */
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        color: #333;
        display: flex;
        flex-direction: column;
        gap: 20px;
        /* ç§»é™¤ min-height: 100vhï¼Œé˜²æ­¢æ’‘åå¸ƒå±€ */
        padding-bottom: 20px;
    }

    /* å¼ºåˆ¶é‡ç½®ç›’æ¨¡å‹ï¼Œé˜²æ­¢å¤–éƒ¨ CSS å¹²æ‰° */
    #music-app * {
        box-sizing: border-box;
    }

    /* --- 1. é¡¶éƒ¨æ æ ·å¼ --- */
    .m-header {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        flex-wrap: wrap; /* å…è®¸å°å±å¹•æ¢è¡Œ */
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }

    .m-title-group {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .m-icon {
        font-size: 24px;
        background: #f0f2f5;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .m-h2 {
        margin: 0;
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
    }

    .m-status {
        font-size: 12px;
        color: #7f8c8d;
    }

    .m-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .m-select {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 36px;
        outline: none;
    }

    .m-btn {
        border: none;
        padding: 0 16px;
        height: 36px;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: opacity 0.2s;
        white-space: nowrap;
    }
    .m-btn:hover { opacity: 0.9; }
    .m-btn-primary { background-color: #3498db; }
    .m-btn-danger { background-color: #e74c3c; }

    .m-speed-box {
        background: #f8f9fa;
        padding: 0 10px;
        height: 36px;
        border-radius: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #666;
        border: 1px solid #eee;
    }

    /* --- 2. ä¹è°±åŒºåŸŸ --- */
    .m-sheet-wrapper {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        min-height: 200px;
        position: relative;
        /* å…è®¸ä¹è°±å†…éƒ¨æ»šåŠ¨ï¼Œä½†ä¸å½±å“å¤–éƒ¨ */
        overflow-x: auto;
        display: flex;
        justify-content: center;
    }
    
    /* ä¿®å¤ SVG å®½åº¦é—®é¢˜ */
    #notation-paper svg {
        max-width: 100%; 
        height: auto;
    }

    .m-cursor {
        position: absolute;
        top: 0; left: 0;
        width: 2px;
        height: 100px;
        background: rgba(231, 76, 60, 0.8);
        box-shadow: 0 0 4px red;
        z-index: 10;
        display: none;
        pointer-events: none;
        transition: left 0.1s linear;
    }

    .m-empty-state {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        color: #bdc3c7;
        font-size: 16px;
        pointer-events: none;
    }

    /* --- 3. é’¢ç´åŒºåŸŸ --- */
    .m-piano-container {
        background: #2d3436;
        border-radius: 8px;
        padding: 10px 0;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        /* ç¡®ä¿ä¸æº¢å‡º */
        width: 100%;
        overflow: hidden; 
    }

    .m-piano-bar {
        padding: 0 20px 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #b2bec3;
        font-size: 12px;
    }

    .m-btn-small {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: #fff;
        padding: 2px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
    }
    .m-btn-small:hover { background: rgba(255,255,255,0.2); }

    /* æ»šåŠ¨å®¹å™¨ï¼šå…³é”®ï¼ */
    .m-piano-scroll-view {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 10px;
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        scrollbar-width: thin;
        scrollbar-color: #636e72 #2d3436;
    }

    .m-piano-body {
        position: relative;
        height: 150px;
        /* å®½åº¦ç”± JS åŠ¨æ€è®¡ç®—ï¼Œæˆ–è€…ç»™ä¸ªå¤§å€¼ */
        width: 2288px; /* 88é”® * 26px */
        margin: 0 auto;
        background: #000;
    }

    /* --- ç´é”®æ ·å¼ --- */
    .m-key {
        position: absolute;
        top: 0;
        height: 100%;
        box-sizing: border-box;
        border-radius: 0 0 4px 4px;
        cursor: pointer;
        transition: all 0.05s;
    }

    .m-key-white {
        width: 26px;
        height: 150px;
        background: #fff;
        border: 1px solid #999;
        z-index: 1;
    }
    .m-key-white.active {
        background: #bdc3c7;
        transform: translateY(2px);
        border-bottom: 5px solid #7f8c8d;
    }

    .m-key-black {
        width: 16px;
        height: 90px;
        background: #111;
        border: 1px solid #000;
        z-index: 2;
        /* ä¿®æ­£é»‘é”®åç§»é‡è®¡ç®— */
    }
    .m-key-black.active {
        background: #555;
        box-shadow: inset 0 0 5px #fff;
        transform: translateY(2px);
    }
    
    /* æ ‡è®°ä¸­å¤® C */
    .m-key[data-note="C4"]::after {
        content: "C4";
        position: absolute;
        bottom: 5px;
        left: 0;
        width: 100%;
        text-align: center;
        color: #999;
        font-size: 10px;
    }
</style>

<script>
(function(){
    // å‘½åç©ºé—´é˜²æ­¢ JS å†²çª
    const MusicApp = {
        songs: [],
        synth: null,
        visualObj: null,
        timer: null,
        cursorEl: null,
        audioContext: null,
        
        init: function() {
            this.cursorEl = document.getElementById('cursor');
            this.renderFullPiano();
            this.fetchData();
            
            const AudioCtor = window.AudioContext || window.webkitAudioContext;
            this.audioContext = new AudioCtor();

            if (ABCJS.synth.supportsAudio()) {
                this.synth = new ABCJS.synth.CreateSynth();
                // å¯åŠ¨å£°éŸ³åŠ è½½
                this.initSynth();
            }
        },

        initSynth: async function() {
            const status = document.getElementById('status-display');
            status.innerText = "â³ æ­£åœ¨åŠ è½½éŸ³æº...";
            try {
                await this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { 
                        program: 0, 
                        // è¿™é‡ŒæŒ‡å‘æœ¬åœ°ï¼Œå¦‚æœæœ¬åœ°æ²¡å¾—æ–‡ä»¶ï¼Œè¯·æš‚æ—¶æ”¹æˆ null ç”¨é»˜è®¤
                        soundFontUrl: "./data/soundfont/" 
                    } 
                });
                await this.synth.prime();
                status.innerText = "âœ… é’¢ç´éŸ³æºå°±ç»ª";
                status.style.color = "#27ae60"; 
            } catch (e) {
                console.warn("åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨éŸ³æº", e);
                status.innerText = "âš ï¸ ä½¿ç”¨é»˜è®¤éŸ³è‰²";
            }
        },

        fetchData: function() {
            const sel = document.getElementById('song-select');
            fetch('data/songs.json')
                .then(r => r.json())
                .then(data => {
                    this.songs = data;
                    sel.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©ä¹è°±...</option>';
                    data.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id; opt.innerText = s.title; sel.appendChild(opt);
                    });
                    document.getElementById('status-display').innerText = "âœ… ä¹è°±åŠ è½½å®Œæ¯•";
                })
                .catch(err => {
                    sel.innerHTML = '<option>âš ï¸ åŠ è½½å¤±è´¥(CORS)</option>';
                });
        },

        loadSong: function(id) {
            this.stop();
            document.getElementById('empty-state').style.display = 'none';
            const song = this.songs.find(s => s.id == id);
            
            // æ¸²æŸ“ ABC
            this.visualObj = ABCJS.renderAbc("notation-paper", song.abc, {
                responsive: "resize",
                scale: 1.1,
                add_classes: true,
                paddingtop: 0,
                paddingbottom: 0
            })[0];

            if (this.synth) {
                this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj
                }).then(() => this.synth.prime());
            }
        },

        play: function() {
            if (!this.visualObj) return alert("è¯·å…ˆé€‰æ‹©ä¹è°±");
            if (this.audioContext.state === 'suspended') this.audioContext.resume();

            if (this.synth) {
                this.timer = new ABCJS.TimingCallbacks(this.visualObj, {
                    eventCallback: (ev) => {
                        if (ev) {
                            if (ev.left !== null) {
                                this.cursorEl.style.display = "block";
                                // +15 æ˜¯ SVG padding ä¿®æ­£
                                this.cursorEl.style.left = (ev.left + 20) + "px"; 
                                this.cursorEl.style.top = ev.top + "px";
                                this.cursorEl.style.height = ev.height + "px";
                            }
                            if (ev.midiPitches) {
                                ev.midiPitches.forEach(p => this.flashKey(p.pitch, 300));
                            }
                        } else {
                            this.cursorEl.style.display = "none";
                        }
                    }
                });
                this.synth.start();
                this.timer.start();
                document.getElementById('btn-play').innerText = "â¸ æ’­æ”¾ä¸­";
            }
        },

        stop: function() {
            if (this.timer) this.timer.stop();
            if (this.synth) this.synth.stop();
            document.getElementById('btn-play').innerText = "â–¶ æ¼”å¥";
            this.clearKeys();
            this.cursorEl.style.display = "none";
        },

        updateTempo: function(val) {
            document.getElementById('tempo-val').innerText = val;
        },

        renderFullPiano: function() {
            const el = document.getElementById('piano-keyboard');
            let html = '';
            let whiteIndex = 0;
            const whiteW = 26; // å¿…é¡»å’Œ CSS .m-key-white width ä¸€è‡´
            
            for (let i = 21; i <= 108; i++) {
                const note = this.getNote(i);
                const isBlack = note.includes('#');
                
                if (!isBlack) {
                    html += `<div class="m-key m-key-white" id="k-${i}" data-midi="${i}" style="left:${whiteIndex * whiteW}px" data-note="${note}"></div>`;
                    whiteIndex++;
                } else {
                    // é»‘é”®ä½ç½®è®¡ç®—
                    const left = (whiteIndex - 1) * whiteW + (whiteW * 0.6);
                    html += `<div class="m-key m-key-black" id="k-${i}" data-midi="${i}" style="left:${left}px"></div>`;
                }
            }
            // åŠ¨æ€è®¾ç½®æ€»å®½åº¦ï¼Œé˜²æ­¢æ¢è¡Œ
            el.style.width = (whiteIndex * whiteW) + "px";
            el.innerHTML = html;

            el.addEventListener('mousedown', (e) => {
                const k = e.target;
                if (!k.classList.contains('m-key')) return;
                const midi = parseInt(k.dataset.midi);
                this.flashKey(midi, 500);
                this.playNoteImmediate(midi);
            });

            // å»¶æ—¶æ»šåŠ¨åˆ°ä¸­å¤®
            setTimeout(() => this.scrollToCenter(), 500);
        },

        scrollToCenter: function() {
            const scroll = document.getElementById('piano-scroll');
            scroll.scrollTo({ left: 600, behavior: 'smooth' });
        },

        getNote: function(midi) {
            const n = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            return n[midi % 12] + (Math.floor(midi/12)-1);
        },

        flashKey: function(midi, time) {
            const k = document.getElementById(`k-${midi}`);
            if (!k) return;
            k.classList.remove('active');
            void k.offsetWidth;
            k.classList.add('active');
            setTimeout(() => k.classList.remove('active'), time);
        },

        clearKeys: function() {
            document.querySelectorAll('.m-key.active').forEach(k => k.classList.remove('active'));
        },

        playNoteImmediate: function(midi) {
            if (this.audioContext.state === 'suspended') this.audioContext.resume();
            const osc = this.audioContext.createOscillator();
            const gain = this.audioContext.createGain();
            osc.frequency.value = 440 * Math.pow(2, (midi - 69) / 12);
            osc.type = 'triangle';
            osc.connect(gain);
            gain.connect(this.audioContext.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
            osc.stop(this.audioContext.currentTime + 0.5);
        }
    };

    window.MusicApp = MusicApp;
    MusicApp.init();
})();
</script>