<script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.2/dist/abcjs-basic-min.js"></script>

<div id="music-app">
    <div class="music-header">
        <div class="header-left">
            <div class="app-icon">ğŸ¹</div>
            <div>
                <h2>ä¹å™¨åŠ©æ‰‹</h2>
                <span class="status-text" id="status-display">ç­‰å¾…åŠ è½½...</span>
            </div>
        </div>
        
        <div class="control-panel">
            <select id="song-select" onchange="MusicApp.loadSong(this.value)">
                <option value="" disabled selected>æ­£åœ¨è¯»å–ä¹è°±åº“...</option>
            </select>

            <div class="divider"></div>

            <button class="btn btn-play" onclick="MusicApp.play()" id="btn-play">â–¶ æ¼”å¥</button>
            <button class="btn btn-stop" onclick="MusicApp.stop()">â¹ åœæ­¢</button>

            <div class="speed-box">
                <label>é€Ÿåº¦</label>
                <input type="range" id="tempo-slider" min="30" max="180" value="90" oninput="MusicApp.updateTempoLabel(this.value)">
                <span id="tempo-val">90 BPM</span>
            </div>
        </div>
    </div>

    <div class="sheet-music-container">
        <div id="notation-placeholder" class="placeholder-text">
            ğŸ‘ˆ è¯·åœ¨å·¦ä¸Šè§’é€‰æ‹©ä¸€é¦–æ›²å­å¼€å§‹å­¦ä¹ 
        </div>
        <div id="notation-paper"></div>
        <div id="midi-player" style="display:none;"></div>
    </div>

    <div class="piano-section">
        <div class="piano-wrapper">
            <div id="piano-keyboard" class="piano">
                </div>
        </div>
        <p class="piano-hint">æç¤ºï¼šç‚¹å‡»ç´é”®å¯è¯•å¬ï¼Œæ’­æ”¾æ—¶ç´é”®ä¼šè‡ªåŠ¨äº®èµ·</p>
    </div>
</div>

<style>
    /* === æ•´ä½“å®¹å™¨æ ·å¼ === */
    #music-app {
        --primary: #6c5ce7;
        --accent: #a29bfe;
        --bg-color: #f8f9fa;
        --text-color: #2d3436;
        font-family: 'Segoe UI', sans-serif;
        background: var(--bg-color);
        padding: 20px;
        border-radius: 12px;
        min-height: 600px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* === é¡¶éƒ¨æ  === */
    .music-header {
        background: #fff;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .app-icon { font-size: 32px; background: #eee; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .music-header h2 { margin: 0; font-size: 18px; color: var(--text-color); }
    .status-text { font-size: 12px; color: #888; }

    .control-panel { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .divider { width: 1px; height: 30px; background: #eee; margin: 0 10px; }
    
    #song-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; min-width: 200px; }
    #song-select:focus { border-color: var(--primary); }

    .btn { border: none; padding: 8px 20px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
    .btn-play { background: #00b894; }
    .btn-play:hover { background: #00a884; transform: translateY(-2px); }
    .btn-play:disabled { background: #ccc; cursor: not-allowed; }
    .btn-stop { background: #ff7675; }
    .btn-stop:hover { background: #d63031; }

    .speed-box { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #666; background: #f1f2f6; padding: 5px 10px; border-radius: 20px; }
    input[type=range] { width: 80px; accent-color: var(--primary); }

    /* === ä¹è°±åŒºåŸŸ === */
    .sheet-music-container {
        flex: 1;
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        min-height: 250px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        overflow-x: auto;
    }
    .placeholder-text { color: #b2bec3; font-size: 16px; }
    /* ABCJS é€‰ä¸­éŸ³ç¬¦é¢œè‰² */
    .abcjs-note_selected { fill: var(--primary); stroke: var(--primary); }

    /* === é’¢ç´åŒºåŸŸ === */
    .piano-section { text-align: center; }
    .piano-wrapper {
        display: inline-block;
        background: #2d3436;
        padding: 25px 15px 15px 15px;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        position: relative;
    }
    /* é’¢ç´å“ç‰Œæ¡ */
    .piano-wrapper::before {
        content: "Midnight Steinway";
        position: absolute;
        top: 8px; left: 0; width: 100%;
        text-align: center;
        color: #b2bec3; font-size: 10px; letter-spacing: 2px;
        font-family: serif;
    }

    .piano { display: flex; position: relative; }
    
    .key {
        position: relative;
        cursor: pointer;
        user-select: none;
        transition: all 0.1s;
    }

    /* ç™½é”® */
    .key.white {
        width: 36px; height: 160px;
        background: linear-gradient(to bottom, #fff 0%, #f1f2f6 100%);
        border-radius: 0 0 4px 4px;
        margin-right: 2px; /* é”®ç¼éš™ */
        z-index: 1;
    }
    .key.white:last-child { margin-right: 0; }
    .key.white.active {
        background: linear-gradient(to bottom, #fff 0%, #74b9ff 100%);
        transform: translateY(2px);
        box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1);
    }

    /* é»‘é”® */
    .key.black {
        width: 24px; height: 100px;
        background: linear-gradient(45deg, #2d3436, #000);
        border-radius: 0 0 3px 3px;
        position: absolute;
        z-index: 2;
        box-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        /* æ ¸å¿ƒï¼šé»‘é”®é€šè¿‡è´Ÿ margin å®šä½åœ¨ä¸¤ä¸ªç™½é”®ä¸­é—´ */
        margin-left: -13px; 
    }
    .key.black.active {
        background: linear-gradient(45deg, #0984e3, #74b9ff);
        box-shadow: inset 0 0 5px rgba(255,255,255,0.5);
    }

    .key-label {
        position: absolute; bottom: 8px; left: 0; width: 100%;
        text-align: center; font-size: 10px; color: #b2bec3; pointer-events: none;
    }

    .piano-hint { font-size: 12px; color: #999; margin-top: 10px; }
</style>

<script>
(function(){
    // éŸ³é«˜å®šä¹‰
    const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

    const MusicApp = {
        songs: [],
        synth: null,
        visualObj: null,
        timingCallbacks: null,
        isPlaying: false,

        init: function() {
            this.renderPiano();
            this.fetchData(); // è·å–JSONæ•°æ®
            
            // åˆå§‹åŒ–éŸ³é¢‘åˆæˆå™¨
            if (ABCJS.synth.supportsAudio()) {
                this.synth = new ABCJS.synth.CreateSynth();
            } else {
                document.getElementById('status-display').innerText = "âŒ æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘";
            }
        },

        // 1. è·å–æ•°æ® (æ ¸å¿ƒ)
        fetchData: function() {
            const selectEl = document.getElementById('song-select');
            const statusEl = document.getElementById('status-display');
            
            fetch('data/songs.json')
                .then(res => {
                    if (!res.ok) throw new Error("File not found");
                    return res.json();
                })
                .then(data => {
                    this.songs = data;
                    selectEl.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©ä¸€é¦–æ›²å­...</option>';
                    data.forEach(song => {
                        const opt = document.createElement('option');
                        opt.value = song.id;
                        opt.innerText = `${song.title} (${song.difficulty})`;
                        selectEl.appendChild(opt);
                    });
                    statusEl.innerText = `âœ… å·²åŠ è½½ ${data.length} é¦–ä¹è°±`;
                })
                .catch(err => {
                    console.error(err);
                    selectEl.innerHTML = '<option>âš ï¸ åŠ è½½å¤±è´¥ (CORSé™åˆ¶)</option>';
                    statusEl.innerText = "âš ï¸ è¯·ä½¿ç”¨ VS Code Live Server æ‰“å¼€";
                    alert("æç¤ºï¼šè¯·ç¡®ä¿ä½ åœ¨æœ¬åœ°æœåŠ¡å™¨(localhost)æˆ– GitHub Pages ç¯å¢ƒä¸‹è¿è¡Œï¼Œå¦åˆ™æ— æ³•è¯»å– JSON æ•°æ®æ–‡ä»¶ã€‚");
                });
        },

        // 2. ç»˜åˆ¶é’¢ç´
        renderPiano: function() {
            const pianoEl = document.getElementById('piano-keyboard');
            let html = '';
            // èŒƒå›´ï¼šC3 (MIDI 48) åˆ° C5 (MIDI 72)
            const startMidi = 48; 
            const endMidi = 72;
            
            for (let i = startMidi; i <= endMidi; i++) {
                const noteName = NOTES[i % 12];
                const isBlack = noteName.includes('#');
                const octave = Math.floor(i / 12) - 1;

                if (!isBlack) {
                    // ç™½é”®
                    html += `<div class="key white" data-midi="${i}" id="key-${i}"><div class="key-label">${noteName}${octave}</div></div>`;
                } else {
                    // é»‘é”®
                    html += `<div class="key black" data-midi="${i}" id="key-${i}"></div>`;
                }
            }
            pianoEl.innerHTML = html;

            // ç»‘å®šé¼ æ ‡ç‚¹å‡»äº‹ä»¶
            pianoEl.addEventListener('mousedown', e => this.handlePianoInput(e, true));
            pianoEl.addEventListener('mouseup', e => this.handlePianoInput(e, false));
            pianoEl.addEventListener('mouseout', e => this.handlePianoInput(e, false));
        },

        handlePianoInput: function(e, isDown) {
            const key = e.target.closest('.key');
            if(!key) return;
            const midi = key.dataset.midi;
            
            if(isDown) {
                if(!key.classList.contains('active')) {
                    key.classList.add('active');
                    this.playBeep(midi); // æ’­æ”¾å£°éŸ³
                }
            } else {
                key.classList.remove('active');
            }
        },

        // 3. åŠ è½½é€‰ä¸­çš„ä¹è°±
        loadSong: function(id) {
            this.stop(); // å…ˆåœæ­¢ä¹‹å‰çš„æ’­æ”¾
            document.getElementById('notation-placeholder').style.display = 'none';
            
            const song = this.songs.find(s => s.id == id);
            if (!song) return;

            // æ¸²æŸ“äº”çº¿è°±
            this.visualObj = ABCJS.renderAbc("notation-paper", song.abc, {
                responsive: "resize",
                scale: 1.2,
                add_classes: true
            })[0];

            // å‡†å¤‡éŸ³é¢‘
            this.initAudio(song.abc);
            document.getElementById('status-display').innerText = `ğŸµ å½“å‰: ${song.title}`;
        },

        // 4. åˆå§‹åŒ–éŸ³é¢‘é€»è¾‘
        initAudio: async function(abcString) {
            if (!this.synth) return;

            try {
                // åˆå§‹åŒ–åˆæˆå™¨ (ä¸‹è½½ SoundFont)
                await this.synth.init({
                    audioContext: new (window.AudioContext || window.webkitAudioContext)(),
                    visualObj: this.visualObj
                });
                
                await this.synth.prime(); // é¢„åŠ è½½ç¼“å†²

                // è®¾ç½®å›è°ƒç›‘å¬å™¨ (è”åŠ¨é’¢ç´)
                this.timingCallbacks = new ABCJS.TimingCallbacks(this.visualObj, {
                    eventCallback: (event) => {
                        // æ¸…é™¤ä¸Šä¸€ä¸ªçŠ¶æ€
                        // æ³¨æ„ï¼šè¿™é‡Œç®€å•æš´åŠ›æ¸…é™¤æ‰€æœ‰ï¼Œä¹Ÿå¯ä¼˜åŒ–ä¸ºåªæ¸…é™¤ ending çš„éŸ³ç¬¦
                        MusicApp.clearAllKeys();

                        if (event && event.midiPitches) {
                            // éå†å½“å‰æ—¶åˆ»çš„æ‰€æœ‰éŸ³ç¬¦ï¼ˆå¯èƒ½æœ‰å’Œå¼¦ï¼‰
                            event.midiPitches.forEach(pitch => {
                                MusicApp.highlightKey(pitch.pitch);
                            });
                        }
                    }
                });

            } catch (error) {
                console.warn("Audio init failed", error);
            }
        },

        // 5. æ’­æ”¾æ§åˆ¶
        play: function() {
            if (!this.synth || !this.visualObj) return;
            if (this.isPlaying) return;

            // è·å–å½“å‰é€Ÿåº¦
            const bpm = document.getElementById('tempo-slider').value;
            // abcjs çš„ millisecondsPerMeasure è®¡ç®—ç¨ç¹çï¼Œç®€æ˜“ç‰ˆé€šå¸¸åœ¨ start æ—¶ä¼ å…¥ tempo å¹¶ä¸ç›´æ¥æ”¯æŒ
            // å®ƒæ˜¯æ ¹æ®ä¹è°±åŸæœ¬çš„é€Ÿåº¦ï¼ˆQ:æ ‡è®°ï¼‰æ’­æ”¾çš„ã€‚
            // è¿™é‡Œä¸ºäº†å®ç°å˜é€Ÿï¼Œæˆ‘ä»¬éœ€è¦åœ¨ renderAbc æ—¶å…¶å®å°±æœ€å¥½æ³¨å…¥é€Ÿåº¦ï¼Œ
            // æˆ–è€…ä½¿ç”¨ timingCallbacks çš„ setProgress æ¯”è¾ƒå¤æ‚ã€‚
            // ä¸ºäº†æ–°æ‰‹å‹å¥½ï¼Œæˆ‘ä»¬è¿™é‡Œæš‚æ—¶ç”¨é»˜è®¤é€Ÿåº¦æ’­æ”¾ï¼Œ
            // âš ï¸ è¿›é˜¶ï¼šå¦‚æœè¦åŠ¨æ€æ”¹å˜é€Ÿåº¦ï¼Œé€šå¸¸éœ€è¦é‡ç½® TimingCallbacks çš„å‚æ•°ã€‚
            // ç®€å•çš„åšæ³•æ˜¯ï¼šä¿®æ”¹ abc å­—ç¬¦ä¸²é‡Œçš„ Q: æ ‡è®°ï¼Œç„¶åé‡æ–° initAudioã€‚
            
            this.synth.start();
            this.timingCallbacks.start();
            this.isPlaying = true;
            document.getElementById('btn-play').innerText = "â¸ æ’­æ”¾ä¸­";
            document.getElementById('btn-play').disabled = true;
        },

        stop: function() {
            if (this.timingCallbacks) this.timingCallbacks.stop();
            if (this.synth) this.synth.stop();
            this.clearAllKeys();
            this.isPlaying = false;
            document.getElementById('btn-play').innerText = "â–¶ æ¼”å¥";
            document.getElementById('btn-play').disabled = false;
        },

        updateTempoLabel: function(val) {
            document.getElementById('tempo-val').innerText = val + " BPM";
            // å®æ—¶å˜é€Ÿæ˜¯é«˜çº§åŠŸèƒ½ï¼Œéœ€è¦æ›´å¤æ‚çš„é€»è¾‘ï¼Œè¿™é‡Œä»…æ›´æ–°UIæ˜¾ç¤º
        },

        // 6. è§†è§‰è¾…åŠ©
        highlightKey: function(midi) {
            const key = document.getElementById(`key-${midi}`);
            if (key) key.classList.add('active');
        },

        clearAllKeys: function() {
            document.querySelectorAll('.key.active').forEach(k => k.classList.remove('active'));
        },

        // 7. ç®€æ˜“å‘éŸ³ (ç”¨äºç‚¹å‡»é’¢ç´é”®æ—¶ï¼Œä¸éœ€è¦åŠ è½½ huge soundfont)
        playBeep: function(midi) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            const freq = 440 * Math.pow(2, (midi - 69) / 12);
            osc.frequency.value = freq;
            osc.type = 'triangle'; // ä¸‰è§’æ³¢å¬èµ·æ¥æ¯”æ­£å¼¦æ³¢æ›´æœ‰â€œä¹å™¨æ„Ÿâ€
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.start();
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
            osc.stop(ctx.currentTime + 0.5);
        }
    };

    window.MusicApp = MusicApp;
    MusicApp.init();
})();
</script>