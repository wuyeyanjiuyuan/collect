<div id="music-app">
    <div class="m-header">
        <div class="m-title-group">
            <div class="m-icon">ğŸ¹</div>
            <div class="m-info">
                <h2 class="m-h2">é’¢ç´æ•™å­¦åŠ©æ‰‹ Pro</h2>
                <span id="status-display" class="m-status">ç­‰å¾…åˆå§‹åŒ–...</span>
            </div>
        </div>

        <div class="m-controls">
            <select id="song-select" class="m-select" onchange="MusicApp.loadSong(this.value)">
                <option value="" disabled selected>è¯»å–ä¹è°±...</option>
            </select>

            <div class="m-btn-group">
                <button class="m-btn m-btn-primary" onclick="MusicApp.togglePlay()" id="btn-play">â–¶ æ’­æ”¾</button>
                <button class="m-btn m-btn-danger" onclick="MusicApp.stop()">â¹ åœæ­¢</button>
            </div>
            
            <div class="m-speed-group">
                <span class="m-label">å€é€Ÿ:</span>
                <button class="m-btn-pill" onclick="MusicApp.setSpeed(0.5, this)">0.5x</button>
                <button class="m-btn-pill active" onclick="MusicApp.setSpeed(1.0, this)">1.0x</button>
                <button class="m-btn-pill" onclick="MusicApp.setSpeed(1.5, this)">1.5x</button>
            </div>
        </div>
    </div>

    <div class="m-sheet-wrapper">
        <div class="m-progress-bar-container">
            <span id="current-time">00:00</span>
            <input type="range" id="seek-slider" class="m-seek-slider" min="0" max="100" value="0" step="1" title="è¿›åº¦æ˜¾ç¤º">
            <span id="total-time">--:--</span>
        </div>

        <div class="m-notation-scroll">
            <div id="notation-paper"></div>
            <div id="cursor" class="m-cursor"></div>
        </div>

        <div id="empty-state" class="m-empty-state">
            ğŸµ è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ä¹è°±å¼€å§‹ç»ƒä¹ 
        </div>
    </div>

    <div class="m-piano-container">
        <div class="m-piano-bar">
            <span class="m-hint">ğŸ’¡ æç¤ºï¼šæŒ‰ Shift + æ»šè½®æ¨ªå‘ç§»åŠ¨ | ç‚¹å‡»ç´é”®è¯•å¬</span>
            <button class="m-btn-small" onclick="MusicApp.scrollToCenter()">ğŸ¯ å›åˆ°ä¸­å¤® C</button>
        </div>
        
        <div class="m-piano-scroll-view" id="piano-scroll">
            <div id="piano-keyboard" class="m-piano-body">
                </div>
        </div>
    </div>
</div>

<style>
    /* === æ ·å¼éš”ç¦»åŒº (m- å‰ç¼€) === */
    #music-app {
        width: 100%; max-width: 100%; box-sizing: border-box;
        font-family: 'Segoe UI', sans-serif; color: #333;
        display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px;
    }
    #music-app * { box-sizing: border-box; }

    /* é¡¶éƒ¨æ  */
    .m-header {
        background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px;
        display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px;
    }
    .m-title-group { display: flex; align-items: center; gap: 10px; }
    .m-icon { font-size: 24px; background: #e3f2fd; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    .m-h2 { margin: 0; font-size: 18px; font-weight: 700; color: #2c3e50; }
    .m-status { font-size: 11px; color: #7f8c8d; }

    .m-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .m-select { padding: 6px; border: 1px solid #ddd; border-radius: 4px; height: 32px; font-size: 13px; }
    
    .m-btn-group { display: flex; gap: 5px; }
    .m-btn { border: none; padding: 0 15px; height: 32px; border-radius: 4px; color: white; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; }
    .m-btn-primary { background-color: #3498db; } .m-btn-primary:hover { background-color: #2980b9; }
    .m-btn-danger { background-color: #e74c3c; } .m-btn-danger:hover { background-color: #c0392b; }

    /* å€é€ŸæŒ‰é’® */
    .m-speed-group { display: flex; align-items: center; gap: 5px; background: #f5f6fa; padding: 4px; border-radius: 20px; }
    .m-label { font-size: 12px; color: #666; margin-left: 5px; margin-right: 5px; }
    .m-btn-pill {
        border: none; background: none; color: #666; font-size: 12px; padding: 4px 8px; border-radius: 12px; cursor: pointer; transition: 0.2s;
    }
    .m-btn-pill:hover { background: #dcdde1; }
    .m-btn-pill.active { background: #3498db; color: white; font-weight: bold; }

    /* ä¹è°±åŒºåŸŸ */
    .m-sheet-wrapper {
        background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px;
        min-height: 220px; position: relative; display: flex; flex-direction: column; gap: 10px;
    }

    .m-progress-bar-container {
        display: flex; align-items: center; gap: 10px; font-size: 12px; color: #666; font-family: monospace;
        background: #fafafa; padding: 5px 10px; border-radius: 4px; border-bottom: 1px solid #eee;
    }
    .m-seek-slider {
        flex: 1; -webkit-appearance: none; height: 4px; background: #dfe6e9; border-radius: 2px; outline: none;
    }
    .m-seek-slider::-webkit-slider-thumb {
        -webkit-appearance: none; width: 12px; height: 12px; background: #3498db; border-radius: 50%;
    }

    .m-notation-scroll {
        position: relative; overflow-x: auto; flex: 1; display: flex; justify-content: center;
    }
    /* ä¿®æ­£ SVG å°ºå¯¸ */
    #notation-paper svg { max-width: 100%; height: auto; }

    /* å…‰æ ‡ä¼˜åŒ– */
    .m-cursor {
        position: absolute; top: 0; left: 0;
        width: 2px; background: rgba(231, 76, 60, 0.9);
        height: 100px; z-index: 10; display: none; pointer-events: none;
        box-shadow: 0 0 6px rgba(231, 76, 60, 0.5);
        transition: left 0.1s linear, top 0.2s ease; /* å¹³æ»‘ç§»åŠ¨ */
    }

    .m-empty-state { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #bdc3c7; font-size: 16px; pointer-events: none; }

    /* é’¢ç´åŒºåŸŸ */
    .m-piano-container { background: #2d3436; border-radius: 8px; padding: 10px 0; width: 100%; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .m-piano-bar { padding: 0 20px 8px 20px; display: flex; justify-content: space-between; color: #b2bec3; font-size: 11px; align-items: center; }
    .m-btn-small { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; }
    
    .m-piano-scroll-view { width: 100%; overflow-x: auto; padding-bottom: 5px; scrollbar-width: thin; scrollbar-color: #636e72 #2d3436; }
    .m-piano-body { position: relative; height: 140px; width: 2288px; margin: 0 auto; background: #111; }
    
    .m-key { position: absolute; top: 0; height: 100%; border-radius: 0 0 4px 4px; cursor: pointer; transition: transform 0.05s, background 0.05s; }
    .m-key-white { width: 26px; height: 140px; background: #fff; border: 1px solid #999; z-index: 1; }
    .m-key-white.active { background: #dfe6e9; transform: translateY(2px) rotateX(-5deg); border-bottom: 4px solid #b2bec3; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1); }
    .m-key-black { width: 16px; height: 85px; background: #111; border: 1px solid #000; z-index: 2; box-shadow: 2px 2px 2px rgba(0,0,0,0.5); }
    .m-key-black.active { background: #333; transform: translateY(2px); box-shadow: inset 0 0 5px #555; }
    .m-key[data-note="C4"]::after { content: "C4"; position: absolute; bottom: 5px; width: 100%; text-align: center; color: #999; font-size: 9px; }
</style>

<script>
(function(){
    const MusicApp = {
        songs: [],
        synth: null,
        visualObj: null,
        timer: null,
        cursorEl: null,
        audioContext: null,
        
        isPlaying: false,
        currentSpeed: 1.0,

        init: function() {
            // æ£€æŸ¥ index.html æ˜¯å¦æ­£ç¡®åŠ è½½äº†åº“
            if (typeof ABCJS === 'undefined') {
                return alert("é”™è¯¯ï¼šabcjs-basic-min.js æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ index.html");
            }

            this.cursorEl = document.getElementById('cursor');
            this.renderFullPiano();
            this.fetchData();
            
            const AudioCtor = window.AudioContext || window.webkitAudioContext;
            this.audioContext = new AudioCtor();

            if (ABCJS.synth.supportsAudio()) {
                this.synth = new ABCJS.synth.CreateSynth();
                // å¯åŠ¨å£°éŸ³åŠ è½½
                this.initSynth();
            }
        },

        initSynth: async function() {
            const status = document.getElementById('status-display');
            status.innerText = "â³ æ­£åœ¨åŠ è½½æœ¬åœ°éŸ³æº...";
            try {
                // åˆå§‹åŒ–ï¼ŒæŒ‡å‘æœ¬åœ° soundfont æ–‡ä»¶å¤¹
                await this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { 
                        program: 0, 
                        // â˜…â˜…â˜… æ ¸å¿ƒï¼šæœ¬åœ°éŸ³æºæ–‡ä»¶å¤¹è·¯å¾„ï¼Œå¿…é¡»ä»¥ / ç»“å°¾ â˜…â˜…â˜…
                        soundFontUrl: "./data/soundfont/" 
                    } 
                });
                await this.synth.prime();
                status.innerText = "âœ… é’¢ç´éŸ³æºå°±ç»ª";
                status.style.color = "#27ae60"; 
            } catch (e) {
                console.warn("éŸ³æºåŠ è½½å¼‚å¸¸", e);
                status.innerText = "âš ï¸ ä½¿ç”¨å¤‡ç”¨ç”µå­éŸ³";
            }
        },

        fetchData: function() {
            const sel = document.getElementById('song-select');
            fetch('data/songs.json')
                .then(r => r.json())
                .then(data => {
                    this.songs = data;
                    sel.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©ä¹è°±...</option>';
                    data.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id; opt.innerText = s.title; sel.appendChild(opt);
                    });
                })
                .catch(() => sel.innerHTML = '<option>âš ï¸ JSONè¯»å–å¤±è´¥</option>');
        },

        loadSong: function(id) {
            this.stop();
            document.getElementById('empty-state').style.display = 'none';
            const song = this.songs.find(s => s.id == id);
            
            // æ¸²æŸ“ä¹è°±
            this.visualObj = ABCJS.renderAbc("notation-paper", song.abc, {
                responsive: "resize",
                scale: 1.1,
                add_classes: true,
                paddingtop: 0, paddingbottom: 0, paddingleft: 0, paddingright: 0
            })[0];

            // é‡æ–°ç»‘å®šéŸ³é¢‘
            if (this.synth) {
                // å¸¦ä¸Šé€Ÿåº¦å‚æ•° warp åˆå§‹åŒ–
                this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { 
                        program: 0, 
                        soundFontUrl: "./data/soundfont/",
                        warp: 100 * this.currentSpeed 
                    }
                }).then(() => {
                    this.synth.prime();
                    this.updateProgressUI(0, 0);
                });
            }
        },

        setSpeed: function(speed, btn) {
            this.currentSpeed = speed;
            document.querySelectorAll('.m-btn-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (this.isPlaying) {
                this.stop();
                this.play(); // é‡å¯ä»¥åº”ç”¨é€Ÿåº¦
            }
        },

        togglePlay: function() {
            if (this.isPlaying) this.stop();
            else this.play();
        },

        play: function() {
            if (!this.visualObj) return alert("è¯·å…ˆé€‰æ‹©ä¹è°±");
            if (this.audioContext.state === 'suspended') this.audioContext.resume();

            if (this.synth) {
                this.isPlaying = true;
                document.getElementById('btn-play').innerText = "â¸ æš‚åœ";
                
                // æ¯æ¬¡æ’­æ”¾å‰é‡æ–° init ç¡®ä¿é€Ÿåº¦ç”Ÿæ•ˆ (Basic Synth é™åˆ¶)
                this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { 
                        program: 0, 
                        soundFontUrl: "./data/soundfont/",
                        warp: 100 * this.currentSpeed 
                    }
                }).then(() => {
                    this.synth.prime();
                    
                    this.timer = new ABCJS.TimingCallbacks(this.visualObj, {
                        eventCallback: (ev) => {
                            if (ev) {
                                // 1. å…‰æ ‡å¯¹é½
                                if (ev.left !== null && ev.left > 0) {
                                    this.cursorEl.style.display = "block";
                                    // +15px æ˜¯ SVG å†…è¾¹è·è¡¥å¿ï¼Œè®©çº¢çº¿å¯¹å‡†éŸ³ç¬¦å·¦ä¾§
                                    this.cursorEl.style.left = (ev.left + 15) + "px"; 
                                    this.cursorEl.style.top = ev.top + "px";
                                    this.cursorEl.style.height = ev.height + "px";
                                }
                                // 2. é’¢ç´è”åŠ¨
                                if (ev.midiPitches) {
                                    ev.midiPitches.forEach(p => this.flashKey(p.pitch, 300 / this.currentSpeed));
                                }
                                // 3. è¿›åº¦æ¡æ›´æ–°
                                if (this.synth.audioBuffer) {
                                    this.updateProgressUI(ev.currentTime, this.synth.audioBuffer.duration);
                                }
                            } else {
                                this.stop();
                            }
                        }
                    });
                    
                    this.synth.start(); 
                    this.timer.start();
                });
            }
        },

        stop: function() {
            if (this.timer) this.timer.stop();
            if (this.synth) this.synth.stop();
            this.isPlaying = false;
            document.getElementById('btn-play').innerText = "â–¶ æ’­æ”¾";
            this.cursorEl.style.display = "none";
            this.clearKeys();
        },

        // === è¿›åº¦æ¡UIæ›´æ–° ===
        updateProgressUI: function(current, total) {
            const slider = document.getElementById('seek-slider');
            const curTimeEl = document.getElementById('current-time');
            const totTimeEl = document.getElementById('total-time');
            
            const format = (t) => {
                const m = Math.floor(t / 60);
                const s = Math.floor(t % 60);
                return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            }

            if(total > 0) {
                slider.value = (current / total) * 100;
                curTimeEl.innerText = format(current);
                totTimeEl.innerText = format(total);
            } else {
                slider.value = 0;
                curTimeEl.innerText = "00:00";
                totTimeEl.innerText = "--:--";
            }
        },

        // === é’¢ç´æ¸²æŸ“ä¸äº¤äº’ ===
        renderFullPiano: function() {
            const el = document.getElementById('piano-keyboard');
            let html = '';
            let whiteIndex = 0;
            const whiteW = 26; 
            
            for (let i = 21; i <= 108; i++) {
                const note = this.getNote(i);
                const isBlack = note.includes('#');
                if (!isBlack) {
                    html += `<div class="m-key m-key-white" id="k-${i}" data-midi="${i}" style="left:${whiteIndex * whiteW}px" data-note="${note}"></div>`;
                    whiteIndex++;
                } else {
                    const left = (whiteIndex - 1) * whiteW + (whiteW * 0.6);
                    html += `<div class="m-key m-key-black" id="k-${i}" data-midi="${i}" style="left:${left}px"></div>`;
                }
            }
            el.style.width = (whiteIndex * whiteW) + "px";
            el.innerHTML = html;

            el.addEventListener('mousedown', (e) => {
                const k = e.target;
                if (!k.classList.contains('m-key')) return;
                const midi = parseInt(k.dataset.midi);
                this.flashKey(midi, 500);
                // æ‰‹åŠ¨ç‚¹å‡»ä½¿ç”¨é«˜çº§å‘å£°ç®—æ³•
                this.playNotePro(midi); 
            });
            setTimeout(() => this.scrollToCenter(), 500);
        },

        scrollToCenter: function() {
            document.getElementById('piano-scroll').scrollTo({ left: 600, behavior: 'smooth' });
        },

        getNote: function(midi) {
            const n = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            return n[midi % 12] + (Math.floor(midi/12)-1);
        },

        flashKey: function(midi, time) {
            const k = document.getElementById(`k-${midi}`);
            if (!k) return;
            k.classList.remove('active');
            void k.offsetWidth;
            k.classList.add('active');
            setTimeout(() => k.classList.remove('active'), time);
        },
        clearKeys: function() { document.querySelectorAll('.m-key.active').forEach(k => k.classList.remove('active')); },

        // === å…³é”®ï¼šé«˜ä¿çœŸé’¢ç´æ¨¡æ‹Ÿ (ç”¨äºæ‰‹åŠ¨ç‚¹å‡») ===
        // è§£å†³äº†â€œç‚¹å‡»ç´é”®åƒç”µå­éŸ³â€çš„é—®é¢˜
        playNotePro: function(midi) {
            if (this.audioContext.state === 'suspended') this.audioContext.resume();
            const t = this.audioContext.currentTime;
            const freq = 440 * Math.pow(2, (midi - 69) / 12);
            
            // ä¸»æŒ¯è¡å™¨(ä¸‰è§’æ³¢æ¨¡æ‹Ÿå¼¦) + æ³›éŸ³(æ­£å¼¦æ³¢)
            const osc = this.audioContext.createOscillator();
            osc.type = 'triangle'; 
            osc.frequency.value = freq;

            const overtone = this.audioContext.createOscillator();
            overtone.type = 'sine';
            overtone.frequency.value = freq * 2;

            // æ»¤æ³¢å™¨æ¨¡æ‹Ÿæœ¨è´¨ç´ç®±å…±é¸£
            const filter = this.audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = freq * 3; // åŠ¨æ€è°ƒæ•´æˆªæ­¢é¢‘ç‡

            const mGain = this.audioContext.createGain();
            const oGain = this.audioContext.createGain();

            osc.connect(filter);
            filter.connect(mGain);
            mGain.connect(this.audioContext.destination);

            overtone.connect(oGain);
            oGain.connect(this.audioContext.destination);

            osc.start(t);
            overtone.start(t);

            // ADSR åŒ…ç»œï¼šæ¨¡æ‹Ÿå‡»å¼¦å†²å‡»æ„Ÿ
            mGain.gain.setValueAtTime(0, t);
            mGain.gain.linearRampToValueAtTime(0.5, t + 0.015); // Attack
            mGain.gain.exponentialRampToValueAtTime(0.01, t + 1.2); // Decay

            oGain.gain.setValueAtTime(0, t);
            oGain.gain.linearRampToValueAtTime(0.1, t + 0.01);
            oGain.gain.exponentialRampToValueAtTime(0.001, t + 0.6);

            osc.stop(t + 1.2);
            overtone.stop(t + 1.2);
        }
    };

    window.MusicApp = MusicApp;
    MusicApp.init();
})();
</script>