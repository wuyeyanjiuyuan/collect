<div id="music-app">
    <div class="music-header">
        <div class="header-main">
            <div class="app-title">
                <span class="icon">ğŸ¹</span>
                <div class="text">
                    <h2>é’¢ç´æ•™å­¦åŠ©æ‰‹</h2>
                    <span class="status" id="status-display">åˆå§‹åŒ–ä¸­...</span>
                </div>
            </div>
            
            <div class="controls">
                <select id="song-select" onchange="MusicApp.loadSong(this.value)">
                    <option value="" disabled selected>æ­£åœ¨è¯»å–ä¹è°±...</option>
                </select>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="MusicApp.play()" id="btn-play">â–¶ æ¼”å¥</button>
                    <button class="btn btn-danger" onclick="MusicApp.stop()">â¹ åœæ­¢</button>
                </div>
            </div>
        </div>

        <div class="header-sub">
            <div class="speed-control">
                <span>é€Ÿåº¦</span>
                <input type="range" id="tempo-slider" min="30" max="180" value="90" oninput="MusicApp.updateTempo(this.value)">
                <span id="tempo-val">90 BPM</span>
            </div>
        </div>
    </div>

    <div class="sheet-music-wrapper">
        <div id="notation-paper"></div>
        <div id="cursor"></div>
        <div id="empty-state" class="empty-state">
            ğŸ‘ˆ è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ä¸€é¦–æ›²å­å¼€å§‹
        </div>
    </div>

    <div class="piano-container">
        <div class="piano-info">
            <span>ğŸ’¡ æç¤ºï¼šæŒ‰ä½ Shift + æ»šè½®å¯å·¦å³ç§»åŠ¨é”®ç›˜</span>
            <button onclick="MusicApp.scrollToCenter()">ğŸ¯ å›åˆ°ä¸­å¤® C</button>
        </div>
        
        <div class="piano-scroll-view" id="piano-scroll">
            <div id="piano-keyboard" class="piano">
                </div>
        </div>
    </div>
</div>

<style>
    /* === å¸ƒå±€é‡ç½® === */
    #music-app {
        --primary: #4a90e2;
        --bg: #f5f7fa;
        background: var(--bg);
        padding: 20px;
        font-family: 'Segoe UI', sans-serif;
        color: #333;
        /* ç§»é™¤ max-heightï¼Œå…è®¸é¡µé¢è‡ªç„¶æ»šåŠ¨ */
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* é¡¶éƒ¨æ  */
    .music-header {
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .header-main { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 10px; }
    .app-title { display: flex; align-items: center; gap: 10px; }
    .app-title .icon { font-size: 28px; background: #eef2f7; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
    .app-title h2 { margin: 0; font-size: 20px; }
    .status { font-size: 12px; color: #888; }
    
    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    #song-select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; min-width: 200px; }
    .btn { border: none; padding: 8px 20px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn-primary { background: var(--primary); }
    .btn-primary:hover { background: #357abd; }
    .btn-danger { background: #ff5b5b; }
    .btn-group { display: flex; gap: 5px; }

    .header-sub { border-top: 1px solid #eee; padding-top: 10px; }
    .speed-control { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #666; }
    input[type=range] { accent-color: var(--primary); }

    /* === ä¹è°±åŒºåŸŸ (å…³é”®ä¿®å¤) === */
    .sheet-music-wrapper {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        /* å¼ºåˆ¶æœ€å°é«˜åº¦ï¼Œé˜²æ­¢çœ‹ä¸è§ */
        min-height: 250px; 
        position: relative;
        overflow-x: auto;
        display: flex;
        justify-content: center;
        align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
    }
    
    /* è®© abcjs ç”Ÿæˆçš„ SVG è‡ªé€‚åº” */
    #notation-paper svg { width: 100% !important; max-width: 1000px; height: auto; }
    
    .cursor {
        position: absolute; width: 2px; background: rgba(255,0,0,0.7); height: 100px; top: 0; left: 0; z-index: 10; display: none; box-shadow: 0 0 5px red; transition: left 0.1s linear;
    }
    .empty-state { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #bbb; font-size: 18px; pointer-events: none; }

    /* === é’¢ç´åŒºåŸŸ === */
    .piano-container {
        background: #2c3e50;
        padding: 15px 0;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .piano-info { text-align: center; color: #95a5a6; font-size: 12px; margin-bottom: 10px; display: flex; justify-content: center; gap: 20px; align-items: center; }
    .piano-info button { background: rgba(255,255,255,0.1); border: none; color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }

    .piano-scroll-view {
        width: 100%;
        overflow-x: auto;
        /* éšè—é»˜è®¤æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        scrollbar-width: thin;
        scrollbar-color: #555 #2c3e50;
        text-align: left; /* å¿…é¡»å·¦å¯¹é½ï¼Œå¦åˆ™ç»å¯¹å®šä½ä¼šä¹± */
        padding-bottom: 10px;
    }

    .piano {
        position: relative;
        height: 160px;
        width: 1980px; /* 88é”® * å®½åº¦é¢„ä¼° */
        margin: 0 auto; /* å±…ä¸­ */
        background: #1a1a1a;
    }

    /* ç´é”®æ ·å¼ä¼˜åŒ– */
    .key {
        position: absolute; top: 0; height: 100%; border-radius: 0 0 4px 4px; box-sizing: border-box; cursor: pointer; transition: background 0.05s, transform 0.05s;
    }
    
    .key.white {
        width: 26px; /* ç¨å¾®è°ƒçª„ */
        height: 160px;
        background: white;
        border: 1px solid #bbb;
        z-index: 1;
    }
    .key.white.active {
        background: #bdc3c7;
        transform: translateY(2px);
        border-bottom: 5px solid #7f8c8d;
    }

    .key.black {
        width: 16px;
        height: 100px;
        background: #111;
        z-index: 2;
        border: 1px solid #000;
        border-top: none;
    }
    .key.black.active {
        background: #444;
        transform: translateY(2px);
        box-shadow: inset 0 0 5px white;
    }

    /* æ ‡è®°ä¸­å¤®C */
    .key[data-note="C4"]::after {
        content: "C4"; position: absolute; bottom: 5px; width: 100%; text-align: center; color: #ccc; font-size: 10px;
    }
</style>

<script>
(function(){
    const MusicApp = {
        songs: [],
        synth: null,
        visualObj: null,
        timer: null,
        cursorEl: null,
        audioContext: null, // å…¨å±€ AudioContext
        
        init: function() {
            this.cursorEl = document.getElementById('cursor');
            this.renderFullPiano();
            this.fetchData();
            
            // åˆå§‹åŒ– AudioContext (ä¸ºäº† Oscillator å¤‡ç”¨)
            const AudioCtor = window.AudioContext || window.webkitAudioContext;
            this.audioContext = new AudioCtor();

            // åˆå§‹åŒ– ABCJS åˆæˆå™¨
            if (ABCJS.synth.supportsAudio()) {
                this.synth = new ABCJS.synth.CreateSynth();
                // å°è¯•é¢„åŠ è½½
                this.initSynth();
            }
        },

        // === 1. åˆå§‹åŒ–å£°éŸ³ (åå°åŠ è½½) ===
        initSynth: async function() {
            const status = document.getElementById('status-display');
            try {
                await this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj,
                    options: { 
                        program: 0, // å¤§é’¢ç´
                        // ä½¿ç”¨æœ¬åœ°æˆ–æ›´å¿«çš„ CDNï¼Œå¦‚æœè¿™ä¸ªæ…¢ï¼Œå¯ä»¥æ¢å›é»˜è®¤
                        soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/MusyngKite/" 
                    } 
                });
                await this.synth.prime();
                status.innerText = "âœ… é’¢ç´éŸ³æºå°±ç»ª";
                status.style.color = "green";
            } catch (e) {
                console.warn("SoundFont load failed, using fallback", e);
                status.innerText = "âš ï¸ ä½¿ç”¨åŸºç¡€éŸ³è‰²";
            }
        },

        // === 2. åŠ è½½ä¹è°±æ•°æ® ===
        fetchData: function() {
            const sel = document.getElementById('song-select');
            fetch('data/songs.json')
                .then(r => r.json())
                .then(data => {
                    this.songs = data;
                    sel.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©ä¹è°±...</option>';
                    data.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id; opt.innerText = s.title; sel.appendChild(opt);
                    });
                    document.getElementById('status-display').innerText = "âœ… æ•°æ®åŠ è½½å®Œæˆ";
                })
                .catch(err => {
                    sel.innerHTML = '<option>âš ï¸ åŠ è½½å¤±è´¥(CORS)</option>';
                    alert("è¯·åœ¨ VS Code Live Server æˆ– GitHub Pages ç¯å¢ƒè¿è¡Œä»¥è¯»å– JSONã€‚");
                });
        },

        // === 3. æ¸²æŸ“ä¹è°± ===
        loadSong: function(id) {
            this.stop();
            document.getElementById('empty-state').style.display = 'none';
            const song = this.songs.find(s => s.id == id);
            
            // æ¸²æŸ“ ABC
            this.visualObj = ABCJS.renderAbc("notation-paper", song.abc, {
                responsive: "resize",
                scale: 1.1,
                add_classes: true,
                paddingtop: 0,
                paddingbottom: 0
            })[0];

            // é‡æ–°ç»‘å®šéŸ³é¢‘
            if (this.synth) {
                this.synth.init({
                    audioContext: this.audioContext,
                    visualObj: this.visualObj
                }).then(() => this.synth.prime());
            }
        },

        // === 4. æ’­æ”¾æ§åˆ¶ ===
        play: function() {
            if (!this.visualObj) return alert("è¯·å…ˆé€‰æ‹©ä¹è°±");
            
            // ğŸ”’ å¿…é¡»åœ¨ç”¨æˆ·æ“ä½œæ—¶æ¢å¤ AudioContext (è§£å†³æ— å£°çš„æ ¸å¿ƒ)
            if (this.audioContext.state === 'suspended') {
                this.audioContext.resume();
            }

            if (this.synth) {
                this.timer = new ABCJS.TimingCallbacks(this.visualObj, {
                    eventCallback: (ev) => {
                        if (ev) {
                            // ç§»åŠ¨å…‰æ ‡
                            if (ev.left !== null) {
                                this.cursorEl.style.display = "block";
                                this.cursorEl.style.left = (ev.left + 15) + "px"; // +padding
                                this.cursorEl.style.top = ev.top + "px";
                                this.cursorEl.style.height = ev.height + "px";
                            }
                            // é’¢ç´è”åŠ¨
                            if (ev.midiPitches) {
                                ev.midiPitches.forEach(p => this.flashKey(p.pitch, 300));
                            }
                        } else {
                            this.cursorEl.style.display = "none";
                        }
                    }
                });
                this.synth.start();
                this.timer.start();
                document.getElementById('btn-play').innerText = "â¸ æ’­æ”¾ä¸­";
            }
        },

        stop: function() {
            if (this.timer) this.timer.stop();
            if (this.synth) this.synth.stop();
            document.getElementById('btn-play').innerText = "â–¶ æ¼”å¥";
            this.clearKeys();
            this.cursorEl.style.display = "none";
        },

        updateTempo: function(val) {
            document.getElementById('tempo-val').innerText = val + " BPM";
        },

        // === 5. é’¢ç´é€»è¾‘ (88é”® + å£°éŸ³ä¿®å¤) ===
        renderFullPiano: function() {
            const el = document.getElementById('piano-keyboard');
            let html = '';
            let whiteIndex = 0;
            const whiteW = 26; // å’Œ CSS ä¸€è‡´
            
            // MIDI 21 (A0) -> 108 (C8)
            for (let i = 21; i <= 108; i++) {
                const note = this.getNote(i);
                const isBlack = note.includes('#');
                
                if (!isBlack) {
                    html += `<div class="key white" id="k-${i}" data-midi="${i}" style="left:${whiteIndex * whiteW}px" data-note="${note}"></div>`;
                    whiteIndex++;
                } else {
                    // é»‘é”®åç§»
                    const left = (whiteIndex - 1) * whiteW + (whiteW * 0.65);
                    html += `<div class="key black" id="k-${i}" data-midi="${i}" style="left:${left}px"></div>`;
                }
            }
            el.innerHTML = html;
            el.style.width = (whiteIndex * whiteW) + "px"; // åŠ¨æ€è®¾å®šæ€»å®½åº¦

            // ç»‘å®šäº‹ä»¶ (è§£å†³æ— å£°)
            el.addEventListener('mousedown', (e) => {
                const k = e.target;
                if (!k.classList.contains('key')) return;
                const midi = parseInt(k.dataset.midi);
                
                // 1. è§†è§‰åé¦ˆ
                this.flashKey(midi, 500);
                
                // 2. å¬è§‰åé¦ˆ (ç«‹å³å“)
                this.playNoteImmediate(midi);
            });

            // é»˜è®¤å±…ä¸­
            setTimeout(() => this.scrollToCenter(), 500);
        },

        scrollToCenter: function() {
            const scroll = document.getElementById('piano-scroll');
            // ç®€å•è®¡ç®— C4 (MIDI 60) çš„å¤§è‡´ä½ç½®
            scroll.scrollTo({ left: 600, behavior: 'smooth' });
        },

        getNote: function(midi) {
            const n = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            return n[midi % 12] + (Math.floor(midi/12)-1);
        },

        flashKey: function(midi, time) {
            const k = document.getElementById(`k-${midi}`);
            if (!k) return;
            k.classList.remove('active');
            void k.offsetWidth; // è§¦å‘é‡ç»˜
            k.classList.add('active');
            setTimeout(() => k.classList.remove('active'), time);
        },

        clearKeys: function() {
            document.querySelectorAll('.key.active').forEach(k => k.classList.remove('active'));
        },

        // â˜…â˜…â˜… å£°éŸ³ä¿®å¤æ ¸å¿ƒæ–¹æ³• â˜…â˜…â˜…
        // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„â€œç”µå­éŸ³â€å‘ç”Ÿå™¨ï¼Œä¸éœ€è¦ç­‰å¾…ç½‘ç»œä¸‹è½½
        // ç”¨æ¥ç¡®ä¿ä½ åœ¨ç‚¹å‡»é”®ç›˜æ—¶ 100% æœ‰å£°éŸ³
        playNoteImmediate: function(midi) {
            if (this.audioContext.state === 'suspended') this.audioContext.resume();
            
            const osc = this.audioContext.createOscillator();
            const gain = this.audioContext.createGain();
            
            // MIDIè½¬é¢‘ç‡
            osc.frequency.value = 440 * Math.pow(2, (midi - 69) / 12);
            osc.type = 'triangle'; // ä¸‰è§’æ³¢éŸ³è‰²æ¯”è¾ƒæŸ”å’Œ
            
            osc.connect(gain);
            gain.connect(this.audioContext.destination);
            
            osc.start();
            // å£°éŸ³åŒ…ç»œ (æ·¡å‡º)
            gain.gain.setValueAtTime(0.3, this.audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
            osc.stop(this.audioContext.currentTime + 0.5);
        }
    };

    window.MusicApp = MusicApp;
    MusicApp.init();
})();
</script>